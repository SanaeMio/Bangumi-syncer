{% extends "base.html" %}

{% block title %}è°ƒè¯•å·¥å…· - Bangumi Syncer{% endblock %}
{% block page_title %}è°ƒè¯•å·¥å…·{% endblock %}

{% block content %}

    <!-- æµ‹è¯•åŒæ­¥ -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-play-circle me-2 text-warning"></i>
                        <h6 class="m-0 fw-semibold">ç•ªå‰§åŒæ­¥æµ‹è¯•</h6>
                    </div>
                </div>
                <div class="card-body">
                    <form id="test-sync-form">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="test-title" class="form-label fw-semibold">
                                    <i class="bi bi-film me-1 text-warning"></i>ç•ªå‰§æ ‡é¢˜
                                </label>
                                <input type="text" class="form-control form-control-lg" id="test-title" placeholder="æµ‹è¯•ç•ªå‰§" required>
                            </div>
                            <div class="col-md-3">
                                <label for="test-season" class="form-label fw-semibold">
                                    <i class="bi bi-calendar3 me-1 text-warning"></i>å­£åº¦
                                </label>
                                <input type="number" class="form-control form-control-lg" id="test-season" value="1" min="1" max="20" required>
                            </div>
                            <div class="col-md-3">
                                <label for="test-episode" class="form-label fw-semibold">
                                    <i class="bi bi-collection-play me-1 text-warning"></i>é›†æ•°
                                </label>
                                <input type="number" class="form-control form-control-lg" id="test-episode" value="1" min="1" max="1000" required>
                            </div>
                            <div class="col-md-3">
                                <label for="test-user" class="form-label fw-semibold">
                                    <i class="bi bi-person me-1 text-warning"></i>ç”¨æˆ·å
                                    <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                       title="åª’ä½“æœåŠ¡å™¨ä¸­çš„ç”¨æˆ·åï¼ˆPlex/Emby/Jellyfinç”¨æˆ·åï¼‰"></i>
                                </label>
                                <input type="text" class="form-control form-control-lg" id="test-user" placeholder="åª’ä½“æœåŠ¡å™¨ç”¨æˆ·å" required>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <button type="button" class="btn btn-warning px-3" id="test-sync-btn" onclick="testSync()">
                                    <i class="bi bi-play-circle me-2"></i>å¼€å§‹æµ‹è¯•
                                </button>
                                <div class="mt-3" id="test-sync-progress" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span id="test-sync-status">æ­£åœ¨æµ‹è¯•åŒæ­¥...</span>
                                    </div>
                                    <div class="progress mt-2" style="height: 6px;">
                                        <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="mt-3" id="test-sync-result" style="display: none;">
                                    <div class="alert alert-dismissible fade show" role="alert" id="test-result-alert">
                                        <div id="test-result-content"></div>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç½‘ç»œè¯Šæ–­å·¥å…· -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-wifi me-2 text-info"></i>
                        <h6 class="m-0 fw-semibold">ç½‘ç»œè¯Šæ–­å·¥å…·</h6>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Bangumiç½‘ç»œè¯Šæ–­ -->
                    <div class="card border-light mb-4">
                        <div class="card-header py-2 bg-light">
                            <h6 class="mb-0 fw-semibold">
                                <i class="bi bi-search me-2 text-info"></i>Bangumi APIè¯Šæ–­
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="bangumi-url" class="form-label fw-semibold">APIåœ°å€</label>
                                <input type="text" class="form-control" id="bangumi-url" 
                                       value="https://api.bgm.tv" readonly>
                            </div>
                            <button type="button" class="btn btn-info" 
                                    onclick="diagnoseBangumiNetwork()" id="diagnose-bangumi-btn">
                                <i class="bi bi-search me-1"></i>å¼€å§‹è¯Šæ–­
                            </button>
                            <div id="bangumi-diagnosis-result" class="mt-3" style="display: none;">
                                <!-- è¯Šæ–­ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰ä¸»æœºè¿é€šæ€§æµ‹è¯• -->
                    <div class="card border-light">
                        <div class="card-header py-2 bg-light">
                            <h6 class="mb-0 fw-semibold">
                                <i class="bi bi-hdd-network me-2 text-success"></i>ä¸»æœºè¿é€šæ€§æµ‹è¯•
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-8">
                                    <label for="test-host" class="form-label fw-semibold">ä¸»æœºåœ°å€</label>
                                    <input type="text" class="form-control" id="test-host" 
                                           placeholder="å¦‚ï¼š192.168.1.100" value="">
                                </div>
                                <div class="col-4">
                                    <label for="test-port" class="form-label fw-semibold">ç«¯å£</label>
                                    <input type="number" class="form-control" id="test-port" 
                                           value="7890" min="1" max="65535">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="test-timeout" class="form-label fw-semibold">è¶…æ—¶æ—¶é—´(ç§’)</label>
                                <input type="number" class="form-control" id="test-timeout" 
                                       value="5" min="1" max="30">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success" 
                                        onclick="testHostConnectivity()" id="test-host-btn">
                                    <i class="bi bi-play-circle me-1"></i>æµ‹è¯•è¿æ¥
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" 
                                        onclick="autoFillHostAddress()" title="è‡ªåŠ¨å¡«å……å¸¸ç”¨ä¸»æœºåœ°å€">
                                    <i class="bi bi-magic"></i>
                                </button>
                            </div>
                            <div id="host-test-result" class="mt-3" style="display: none;">
                                <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æµ‹è¯• -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-bell me-2 text-warning"></i>
                        <h6 class="m-0 fw-semibold">é€šçŸ¥æµ‹è¯•</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        æµ‹è¯•å½“å‰é…ç½®çš„é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å¦‚éœ€é…ç½®é€šçŸ¥ï¼Œè¯·å‰å¾€ã€Œé…ç½®ç®¡ç†ã€é¡µé¢ã€‚
                    </div>
                    
                    <div class="row g-3">
                        <!-- Webhook æµ‹è¯• -->
                        <div class="col-md-6">
                            <div class="card border-light">
                                <div class="card-header py-2 bg-light">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="bi bi-webhook me-2 text-primary"></i>Webhook é€šçŸ¥
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <button type="button" class="btn btn-primary w-100" onclick="testWebhookNotification()" id="test-webhook-btn">
                                        <i class="bi bi-send me-1"></i>æµ‹è¯• Webhook
                                    </button>
                                    <div id="webhook-test-result" class="mt-3" style="display: none;">
                                        <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é‚®ä»¶æµ‹è¯• -->
                        <div class="col-md-6">
                            <div class="card border-light">
                                <div class="card-header py-2 bg-light">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="bi bi-envelope me-2 text-success"></i>é‚®ä»¶é€šçŸ¥
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <button type="button" class="btn btn-success w-100" onclick="testEmailNotification()" id="test-email-btn">
                                        <i class="bi bi-send me-1"></i>æµ‹è¯•é‚®ä»¶
                                    </button>
                                    <div id="email-test-result" class="mt-3" style="display: none;">
                                        <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
// æµ‹è¯•åŒæ­¥åŠŸèƒ½
async function testSync() {
    const btn = document.getElementById('test-sync-btn');
    const progressDiv = document.getElementById('test-sync-progress');
    const resultDiv = document.getElementById('test-sync-result');
    const resultAlert = document.getElementById('test-result-alert');
    const resultContent = document.getElementById('test-result-content');
    const statusSpan = document.getElementById('test-sync-status');
    
    // è·å–è¡¨å•æ•°æ®
    const title = document.getElementById('test-title').value.trim();
    const season = parseInt(document.getElementById('test-season').value);
    const episode = parseInt(document.getElementById('test-episode').value);
    const user = document.getElementById('test-user').value.trim();
    
    // éªŒè¯è¾“å…¥
    if (!title || !season || !episode || !user) {
        showAlert('è¯·å¡«å†™å®Œæ•´çš„æµ‹è¯•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·å', 'warning', 3000);
        return;
    }
    
    // æ˜¾ç¤ºè¿›åº¦ï¼Œéšè—ä¹‹å‰çš„ç»“æœ
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>æµ‹è¯•ä¸­...';
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    try {
        const testData = {
            title: title,
            season: season,
            episode: episode,
            user_name: user
        };
        
        // æ›´æ–°çŠ¶æ€
        statusSpan.textContent = `æ­£åœ¨æµ‹è¯•åŒæ­¥: ${title} S${season.toString().padStart(2, '0')}E${episode.toString().padStart(2, '0')}`;
        
        const startTime = Date.now();
        
        const response = await fetch('/api/test-sync?async_mode=false', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        const result = await response.json();
        const endTime = Date.now();
        const actualTime = ((endTime - startTime) / 1000).toFixed(2);
        
        // éšè—è¿›åº¦ï¼Œæ˜¾ç¤ºç»“æœ
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºè¿æ¥æˆåŠŸï¼ˆåŒ…æ‹¬æˆåŠŸåŒæ­¥å’Œå·²çœ‹è¿‡çŠ¶æ€ï¼‰
        const isConnectionSuccess = result.success || 
                                   (result.message && (
                                       result.message.includes('å·²çœ‹è¿‡') || 
                                       result.message.includes('å·²æ ‡è®°') ||
                                       result.message.includes('é‡å¤') ||
                                       result.message.includes('å·²å­˜åœ¨')
                                   ));
        
        if (isConnectionSuccess) {
            // æ ¹æ®æ˜¯å¦çœŸæ­£åŒæ­¥æˆåŠŸæ¥å†³å®šæ˜¾ç¤ºå†…å®¹
            const isActualSync = result.success;
            const statusText = isActualSync ? 'æµ‹è¯•åŒæ­¥æˆåŠŸï¼' : 'è¿æ¥æµ‹è¯•æˆåŠŸï¼';
            const statusIcon = isActualSync ? 'bi-check-circle-fill' : 'bi-info-circle-fill';
            const statusColor = isActualSync ? 'success' : 'info';
            
            resultAlert.className = `alert alert-${statusColor} alert-dismissible fade show`;
            resultContent.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="bi ${statusIcon} text-${statusColor} me-3 mt-1"></i>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
                            <h6 class="mb-0 text-${statusColor} fw-bold">${statusText}</h6>
                            <small class="text-muted">
                                <i class="bi bi-stopwatch me-1"></i>${result.elapsed_time || actualTime + 'ç§’'}
                            </small>
                        </div>
                        <div class="mb-3">
                            <span class="text-muted me-2">
                                <i class="bi bi-film me-1"></i>${result.test_info?.title || title}
                            </span>
                            <span class="badge bg-secondary me-2">${result.test_info?.episode || 'S' + season.toString().padStart(2, '0') + 'E' + episode.toString().padStart(2, '0')}</span>
                            ${result.data && (result.data.subject_id || result.data.episode_id) ? `
                                ${result.data.subject_id ? `
                                <a href="https://bgm.tv/subject/${result.data.subject_id}" 
                                   target="_blank" 
                                   class="badge bg-primary text-decoration-none me-1"
                                   title="ç‚¹å‡»æ‰“å¼€Bangumiç•ªå‰§é¡µé¢">
                                    <i class="bi bi-link-45deg me-1"></i>Bangumi ID: ${result.data.subject_id}
                                </a>
                                ` : ''}
                                ${result.data.episode_id ? `
                                <a href="https://bgm.tv/ep/${result.data.episode_id}" 
                                   target="_blank" 
                                   class="badge bg-info text-decoration-none"
                                   title="ç‚¹å‡»æ‰“å¼€Bangumiå‰§é›†é¡µé¢">
                                    <i class="bi bi-link-45deg me-1"></i>EP ID: ${result.data.episode_id}
                                </a>
                                ` : ''}
                            ` : ''}
                        </div>
                        ${result.message ? `
                            <div class="mb-0">
                                <p class="mb-1 text-muted small"><strong>ç»“æœè¯´æ˜ï¼š</strong></p>
                                <p class="mb-0 text-muted small">${result.message}</p>
                                ${!isActualSync ? `
                                    <p class="mb-0 text-info small mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        è¿æ¥å’Œè®¤è¯æ­£å¸¸ï¼ŒåŒæ­¥ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚
                                    </p>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            resultAlert.className = 'alert alert-danger alert-dismissible fade show';
            resultContent.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">æµ‹è¯•åŒæ­¥å¤±è´¥</h6>
                        <p class="mb-2">${result.message}</p>
                        <div class="row g-2 small text-muted">
                            <div class="col-md-8">
                                <strong>ç•ªå‰§:</strong> ${title} S${season.toString().padStart(2, '0')}E${episode.toString().padStart(2, '0')}
                            </div>
                            <div class="col-md-4">
                                <strong>è€—æ—¶:</strong> ${result.elapsed_time || actualTime + 'ç§’'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('æµ‹è¯•åŒæ­¥å¤±è´¥:', error);
        
        // éšè—è¿›åº¦ï¼Œæ˜¾ç¤ºé”™è¯¯
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        resultAlert.className = 'alert alert-danger alert-dismissible fade show';
        resultContent.innerHTML = `
            <div class="d-flex align-items-start">
                <i class="bi bi-x-circle-fill text-danger me-2 mt-1"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-1">ç½‘ç»œé”™è¯¯</h6>
                    <p class="mb-0">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</p>
                    <small class="text-muted">é”™è¯¯è¯¦æƒ…: ${error.message}</small>
                </div>
            </div>
        `;
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle me-2"></i>å¼€å§‹æµ‹è¯•';
    }
}

// Bangumiç½‘ç»œè¯Šæ–­
async function diagnoseBangumiNetwork() {
    const button = document.getElementById('diagnose-bangumi-btn');
    const resultDiv = document.getElementById('bangumi-diagnosis-result');
    const urlInput = document.getElementById('bangumi-url');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>è¯Šæ–­ä¸­...';
    
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-info me-3" role="status">
                    <span class="visually-hidden">è¯Šæ–­ä¸­...</span>
                </div>
                <div>
                    <h6 class="mb-1">æ­£åœ¨è¯Šæ–­ç½‘ç»œè¿æ¥</h6>
                    <small class="text-muted">æ£€æµ‹DNSè§£æå’ŒTCPè¿æ¥...</small>
                </div>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/network/diagnose', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: urlInput.value })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            displayBangumiDiagnosisResult(result.data);
        } else {
            showBangumiDiagnosisError(result.message);
        }
        
    } catch (error) {
        console.error('Bangumiç½‘ç»œè¯Šæ–­å¤±è´¥:', error);
        showBangumiDiagnosisError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿›è¡Œè¯Šæ–­');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-search me-1"></i>å¼€å§‹è¯Šæ–­';
    }
}

// æ˜¾ç¤ºBangumiè¯Šæ–­ç»“æœ
function displayBangumiDiagnosisResult(data) {
    const resultDiv = document.getElementById('bangumi-diagnosis-result');
    
    let html = `
        <div class="alert alert-light border">
            <h6 class="mb-3">
                <i class="bi bi-list-check me-2 text-info"></i>
                ç½‘ç»œè¯Šæ–­ç»“æœ - ${data.hostname}:${data.port}
            </h6>
            
            <!-- ç¯å¢ƒä¿¡æ¯ -->
            ${data.environment ? `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-pc-display me-2 text-info"></i>
                    è¿è¡Œç¯å¢ƒ
                </h6>
                <div class="ms-4">
                    <span class="badge ${data.environment.is_docker ? 'bg-primary' : 'bg-secondary'} me-2">
                        ${data.environment.is_docker ? 
                            `Dockerå®¹å™¨ (${data.environment.network_mode}æ¨¡å¼)` : 
                            'æœ¬æœºç¯å¢ƒ'
                        }
                    </span>
                    ${data.environment.is_docker ? 
                        '<small class="text-muted d-block mt-1">Dockerç¯å¢ƒä¸‹DNSè§£æå¯èƒ½ç»è¿‡å®¹å™¨ç½‘ç»œè½¬å‘</small>' : 
                        ''
                    }
                </div>
            </div>
            ` : ''}
            
            <!-- ä»£ç†é…ç½®ä¿¡æ¯ -->
            ${data.proxy_config ? `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-shield-check me-2 text-success"></i>
                    ä»£ç†é…ç½®
                </h6>
                <div class="ms-4">
                    <code class="text-success">${data.proxy_config}</code>
                    ${data.proxy_config === 'æœªé…ç½®ä»£ç†' ? 
                        '<small class="text-muted d-block mt-1">å°†ä½¿ç”¨ç›´æ¥è¿æ¥è¿›è¡Œæµ‹è¯•</small>' : 
                        '<small class="text-success d-block mt-1">HTTPè¿æ¥æµ‹è¯•å°†ä½¿ç”¨æ­¤ä»£ç†</small>'
                    }
                </div>
            </div>
            ` : ''}
            
            <!-- ç³»ç»ŸDNSä¿¡æ¯ -->
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-hdd-network me-2 text-secondary"></i>
                    DNSé…ç½®
                </h6>
                <div class="ms-4">
                    ${data.dns_servers && data.dns_servers.length > 0 ? 
                        data.dns_servers.map(dns => {
                            // ç‰¹æ®Šå¤„ç†Dockerç›¸å…³çš„DNSä¿¡æ¯
                            if (dns.includes('Docker') || dns.includes('å®¹å™¨') || dns.includes('127.0.0.11')) {
                                return `<div class="mb-1"><code class="text-primary">${dns}</code></div>`;
                            } else if (dns.includes('æ³¨æ„:')) {
                                return `<div class="mb-1"><small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>${dns}</small></div>`;
                            } else {
                                return `<code class="me-2 mb-1 d-inline-block">${dns}</code>`;
                            }
                        }).join('') :
                        '<small class="text-muted">æ— æ³•è·å–DNSæœåŠ¡å™¨ä¿¡æ¯</small>'
                    }
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            å¸¸ç”¨DNSæœåŠ¡å™¨ï¼š
                            <code class="ms-1">8.8.8.8</code>
                            <code class="ms-1">114.114.114.114</code>
                            <code class="ms-1">1.1.1.1</code>
                        </small>
                    </div>
                </div>
            </div>
    `;
    
    data.diagnosis.forEach(test => {
        const statusIcon = test.status === 'success' ? 'bi-check-circle-fill text-success' : 
                          test.status === 'failed' ? 'bi-x-circle-fill text-danger' : 
                          'bi-exclamation-triangle-fill text-warning';
        
        html += `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi ${statusIcon} me-2"></i>
                    ${test.test}
                </h6>
                <p class="mb-2 ms-4">${test.message}</p>
        `;
        
        if (test.suggestions) {
            html += `
                <div class="ms-4">
                    <small class="text-muted fw-semibold">ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:</small>
                    <ul class="small text-muted mt-1 mb-0">
            `;
            test.suggestions.forEach(suggestion => {
                html += `<li>${suggestion}</li>`;
            });
            html += `</ul></div>`;
        }
        
        if (test.ips) {
            html += `
                <div class="ms-4">
                    <small class="text-muted">è§£æåˆ°çš„IPåœ°å€: <code>${test.ips.join(', ')}</code></small>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºä»£ç†å’ŒSSLä¿¡æ¯
        if (test.proxy_used !== undefined) {
            html += `
                <div class="ms-4">
                    <small class="text-muted">
                        ä»£ç†: <code>${test.proxy_used}</code>
                        ${test.ssl_verify !== undefined ? ` | SSLéªŒè¯: <code>${test.ssl_verify ? 'å¯ç”¨' : 'ç¦ç”¨'}</code>` : ''}
                    </small>
                </div>
            `;
        }
        
        html += `</div>`;
    });
    
    // æ·»åŠ æ€»ç»“æ€§å»ºè®®
    const dnsSuccess = data.diagnosis.some(t => t.test === 'DNSè§£æ' && t.status === 'success');
    const tcpSuccess = data.diagnosis.some(t => (t.test === 'TCPè¿æ¥' || t.test === 'TCPç›´è¿') && t.status === 'success');
    const httpSuccess = data.diagnosis.some(t => t.test === 'HTTPè¿æ¥' && t.status === 'success');
    const isDockerEnv = data.environment && data.environment.is_docker;
    
    if (dnsSuccess && (tcpSuccess || httpSuccess)) {
        let statusDetails = [];
        if (tcpSuccess) statusDetails.push('TCPè¿æ¥æˆåŠŸ');
        if (httpSuccess) statusDetails.push('HTTPè¿æ¥æˆåŠŸ');
        
        html += `
            <div class="alert alert-success mb-0">
                <i class="bi bi-check-circle me-2"></i>
                <strong>ç½‘ç»œè¿æ¥æ­£å¸¸ï¼</strong> DNSè§£æå’Œ${statusDetails.join('ã€')}ï¼ŒBangumi APIå¯ä»¥æ­£å¸¸è®¿é—®ã€‚
                ${isDockerEnv ? '<br><small>Dockerç¯å¢ƒä¸‹ç½‘ç»œæ­£å¸¸ï¼Œå®¹å™¨å¯ä»¥æ­£å¸¸è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚</small>' : ''}
            </div>
        `;
    } else if (!dnsSuccess) {
        let suggestions = [];
        if (isDockerEnv) {
            suggestions = [
                "æ£€æŸ¥Dockerå®¹å™¨çš„DNSé…ç½®",
                "å°è¯•é‡å¯Dockerå®¹å™¨",
                "æ£€æŸ¥Dockerå®¿ä¸»æœºçš„DNSè®¾ç½®",
                "åœ¨docker runæ—¶ä½¿ç”¨ --dns=8.8.8.8 å‚æ•°",
                "æ£€æŸ¥Dockerç½‘ç»œæ¨¡å¼æ˜¯å¦æ­£ç¡®"
            ];
        } else {
            suggestions = [
                "æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸",
                "å°è¯•æ›´æ¢DNSæœåŠ¡å™¨ (8.8.8.8æˆ–114.114.114.114)",
                "æ£€æŸ¥æ˜¯å¦éœ€è¦é…ç½®ä»£ç†"
            ];
        }
        
        html += `
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>DNSè§£æå¤±è´¥</strong> - è¿™æ˜¯å¯¼è‡´è¿æ¥é—®é¢˜çš„ä¸»è¦åŸå› ã€‚
                <div class="mt-2">
                    <strong>${isDockerEnv ? 'Dockerç¯å¢ƒ' : ''}è§£å†³å»ºè®®ï¼š</strong>
                    <ul class="mb-0 mt-1">
                        ${suggestions.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    } else if (dnsSuccess && !tcpSuccess && !httpSuccess) {
        html += `
            <div class="alert alert-warning mb-0">
                <i class="bi bi-shield-x me-2"></i>
                <strong>è¿æ¥è¢«é˜»æ­¢</strong> - DNSè§£ææ­£å¸¸ä½†æ— æ³•å»ºç«‹TCPæˆ–HTTPè¿æ¥ï¼Œå¯èƒ½è¢«é˜²ç«å¢™æˆ–ç½‘ç»œç­–ç•¥é˜»æ­¢ã€‚
                ${isDockerEnv ? '<br><small>Dockerç¯å¢ƒä¸‹è¯·æ£€æŸ¥ç«¯å£æ˜ å°„å’Œç½‘ç»œç­–ç•¥ã€‚</small>' : ''}
            </div>
        `;
    } else if (dnsSuccess && !tcpSuccess && httpSuccess) {
        html += `
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>
                <strong>éƒ¨åˆ†è¿æ¥æˆåŠŸ</strong> - TCPç›´è¿å¤±è´¥ä½†HTTPè¿æ¥æˆåŠŸï¼Œå¯èƒ½éœ€è¦é€šè¿‡ä»£ç†è®¿é—®ã€‚
                ${isDockerEnv ? '<br><small>Dockerç¯å¢ƒä¸‹å»ºè®®æ£€æŸ¥ç½‘ç»œé…ç½®ã€‚</small>' : ''}
            </div>
        `;
    }
    
    html += `</div>`;
    resultDiv.innerHTML = html;
}

// æ˜¾ç¤ºBangumiè¯Šæ–­é”™è¯¯
function showBangumiDiagnosisError(message) {
    const resultDiv = document.getElementById('bangumi-diagnosis-result');
    resultDiv.innerHTML = `
        <div class="alert alert-danger">
            <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>
                è¯Šæ–­å¤±è´¥
            </h6>
            <p class="mb-0">${message}</p>
        </div>
    `;
}

// è‡ªåŠ¨å¡«å……ä¸»æœºåœ°å€
function autoFillHostAddress() {
    const hostInput = document.getElementById('test-host');
    const portInput = document.getElementById('test-port');
    const currentPort = portInput.value || '7890';
    
    // åŸºäºå½“å‰é¡µé¢URLæ¨æµ‹åˆé€‚çš„ä¸»æœºåœ°å€
    const currentHost = window.location.hostname;
    
    let suggestedHost = '';
    
    if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
        // æœ¬åœ°ç¯å¢ƒï¼Œå»ºè®®æµ‹è¯•ç½‘å…³
        suggestedHost = '192.168.1.1';
    } else if (currentHost.startsWith('192.168.')) {
        // å±€åŸŸç½‘ç¯å¢ƒï¼Œå»ºè®®æµ‹è¯•ç½‘å…³æˆ–å…¶ä»–å¸¸è§IP
        const parts = currentHost.split('.');
        if (parts.length === 4) {
            // ä½¿ç”¨ç›¸åŒç½‘æ®µçš„ç½‘å…³
            suggestedHost = `${parts[0]}.${parts[1]}.${parts[2]}.1`;
        } else {
            suggestedHost = '192.168.1.1';
        }
    } else {
        // å…¶ä»–ç¯å¢ƒï¼Œä½¿ç”¨å¸¸è§çš„å±€åŸŸç½‘åœ°å€
        suggestedHost = '192.168.1.1';
    }
    
    hostInput.value = suggestedHost;
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    showAlert(`å·²è‡ªåŠ¨å¡«å…¥ ${suggestedHost}:${currentPort}ï¼Œè¿™æ˜¯åŸºäºå½“å‰ç½‘ç»œç¯å¢ƒçš„æ¨æµ‹`, 'info', 3000);
}

// ä¸»æœºè¿é€šæ€§æµ‹è¯•
async function testHostConnectivity() {
    const button = document.getElementById('test-host-btn');
    const resultDiv = document.getElementById('host-test-result');
    const host = document.getElementById('test-host').value.trim();
    const port = parseInt(document.getElementById('test-port').value);
    const timeout = parseInt(document.getElementById('test-timeout').value);
    
    if (!host) {
        showAlert('è¯·è¾“å…¥ä¸»æœºåœ°å€', 'warning', 3000);
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>æµ‹è¯•ä¸­...';
    
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-info me-3" role="status">
                    <span class="visually-hidden">æµ‹è¯•ä¸­...</span>
                </div>
                <div>
                    <h6 class="mb-1">æ­£åœ¨æµ‹è¯•è¿æ¥</h6>
                    <small class="text-muted">æ£€æµ‹åˆ° ${host}:${port} çš„è¿é€šæ€§...</small>
                </div>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/proxy/test-host', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ host, port, timeout })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            displayHostTestResult(result.data);
        } else {
            showHostTestError(result.message);
        }
        
    } catch (error) {
        console.error('ä¸»æœºè¿é€šæ€§æµ‹è¯•å¤±è´¥:', error);
        showHostTestError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿›è¡Œæµ‹è¯•');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-circle me-1"></i>æµ‹è¯•è¿æ¥';
    }
}

// æ˜¾ç¤ºä¸»æœºæµ‹è¯•ç»“æœ
function displayHostTestResult(data) {
    const resultDiv = document.getElementById('host-test-result');
    
    let html = `
        <div class="alert alert-light border">
            <h6 class="mb-3">
                <i class="bi bi-hdd-network me-2 text-info"></i>
                è¿é€šæ€§æµ‹è¯•ç»“æœ - ${data.host}:${data.port}
            </h6>
    `;
    
    // TCPè¿æ¥æµ‹è¯•ç»“æœ
    const tcpSuccess = data.tcp_reachable;
    const tcpIcon = tcpSuccess ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
    
    html += `
        <div class="mb-3">
            <h6 class="mb-2">
                <i class="bi ${tcpIcon} me-2"></i>
                TCPè¿æ¥æµ‹è¯•
            </h6>
            <p class="mb-2 ms-4">${tcpSuccess ? 'TCPè¿æ¥æˆåŠŸ' : 'TCPè¿æ¥å¤±è´¥'}</p>
            <div class="ms-4">
                <small class="text-muted">è€—æ—¶: ${data.tcp_time}ms</small>
            </div>
        </div>
    `;
    
    // Pingæµ‹è¯•ç»“æœ
    if (data.ping_reachable !== null) {
        const pingSuccess = data.ping_reachable;
        const pingIcon = pingSuccess ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
        
        html += `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi ${pingIcon} me-2"></i>
                    Pingæµ‹è¯•
                </h6>
                <p class="mb-2 ms-4">${pingSuccess ? 'PingæˆåŠŸ' : 'Pingå¤±è´¥æˆ–æ— æƒé™'}</p>
                ${data.ping_time ? `
                    <div class="ms-4">
                        <small class="text-muted">å¹³å‡å»¶è¿Ÿ: ${data.ping_time}ms</small>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // è¯¦ç»†ä¿¡æ¯
    if (data.details) {
        html += `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-info-circle me-2 text-info"></i>
                    è¯¦ç»†ä¿¡æ¯
                </h6>
                <div class="ms-4">
                    <small class="text-muted">${data.details}</small>
                </div>
            </div>
        `;
    }
    
    // æ€»ç»“æ€§å»ºè®®
    if (tcpSuccess) {
        html += `
            <div class="alert alert-success mb-0">
                <i class="bi bi-check-circle me-2"></i>
                <strong>è¿æ¥æˆåŠŸï¼</strong> ç›®æ ‡ä¸»æœºå’Œç«¯å£å¯ä»¥æ­£å¸¸è®¿é—®ã€‚
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>è¿æ¥å¤±è´¥</strong> - æ— æ³•è¿æ¥åˆ°ç›®æ ‡ä¸»æœºï¼Œè¯·æ£€æŸ¥ä¸»æœºåœ°å€ã€ç«¯å£å·å’Œç½‘ç»œé…ç½®ã€‚
            </div>
        `;
    }
    
    html += `</div>`;
    resultDiv.innerHTML = html;
}

// æ˜¾ç¤ºä¸»æœºæµ‹è¯•é”™è¯¯
function showHostTestError(message) {
    const resultDiv = document.getElementById('host-test-result');
    resultDiv.innerHTML = `
        <div class="alert alert-danger">
            <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>
                æµ‹è¯•å¼‚å¸¸
            </h6>
            <p class="mb-0">${message}</p>
        </div>
    `;
}


// å¤åˆ¶åˆ°å‰ªè´´æ¿
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        showAlert('ä»£ç†åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success', 2000);
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'warning', 3000);
    }
}

// æµ‹è¯•ä»£ç†è¿é€šæ€§
async function testProxy(address, event) {
    event.stopPropagation(); // é˜»æ­¢å†’æ³¡
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>æµ‹è¯•ä¸­';
    
    try {
        const response = await fetch('/api/proxy/test', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ proxy_url: address })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert(`ä»£ç†æµ‹è¯•æˆåŠŸï¼å»¶è¿Ÿ: ${result.data.response_time_ms}ms`, 'success', 3000);
        } else {
            showAlert(`ä»£ç†æµ‹è¯•å¤±è´¥: ${result.message}`, 'danger', 5000);
        }
        
    } catch (error) {
        console.error('ä»£ç†æµ‹è¯•å¤±è´¥:', error);
        showAlert('ä»£ç†æµ‹è¯•å¼‚å¸¸', 'danger', 3000);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Toastæç¤ºå‡½æ•°
function showAlert(message, type = 'info', duration = 3000) {
    // åˆ›å»ºToastå®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1050';
        document.body.appendChild(toastContainer);
    }
    
    // åˆ›å»ºToastå…ƒç´ 
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // åˆå§‹åŒ–Bootstrap Toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: duration
    });
    
    // æ˜¾ç¤ºToast
    bsToast.show();
    
    // è‡ªåŠ¨ç§»é™¤å…ƒç´ 
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// æµ‹è¯• Webhook é€šçŸ¥
async function testWebhookNotification() {
    await testNotificationByType('webhook', 'test-webhook-btn', 'webhook-test-result');
}

// æµ‹è¯•é‚®ä»¶é€šçŸ¥
async function testEmailNotification() {
    await testNotificationByType('email', 'test-email-btn', 'email-test-result');
}

// é€šç”¨é€šçŸ¥æµ‹è¯•å‡½æ•°
async function testNotificationByType(type, btnId, resultDivId) {
    const btn = document.getElementById(btnId);
    const resultDiv = document.getElementById(resultDivId);
    
    // ç¦ç”¨æŒ‰é’®
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>æµ‹è¯•ä¸­...';
    
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="alert alert-info mb-0">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2"></div>
                <span>æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...</span>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/notification/test', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                notification_type: type
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const result = data.data[type];
            
            if (!result.enabled) {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <h6 class="alert-heading mb-2"><i class="bi bi-exclamation-triangle me-2"></i>æœªå¯ç”¨</h6>
                        <p class="mb-0 small">è¯¥é€šçŸ¥æ–¹å¼æœªå¯ç”¨ï¼Œè¯·å‰å¾€ã€Œé…ç½®ç®¡ç†ã€é¡µé¢é…ç½®ã€‚</p>
                    </div>
                `;
                showAlert(`${type === 'webhook' ? 'Webhook' : 'é‚®ä»¶'}é€šçŸ¥æœªå¯ç”¨`, 'warning');
            } else if (result.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <h6 class="alert-heading mb-2"><i class="bi bi-check-circle me-2"></i>æµ‹è¯•æˆåŠŸ</h6>
                        <p class="mb-0 small">${result.message}</p>
                    </div>
                `;
                showAlert(`${type === 'webhook' ? 'Webhook' : 'é‚®ä»¶'}é€šçŸ¥æµ‹è¯•æˆåŠŸï¼`, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <h6 class="alert-heading mb-2"><i class="bi bi-x-circle me-2"></i>æµ‹è¯•å¤±è´¥</h6>
                        <p class="mb-2 small">${result.message}</p>
                        <hr class="my-2">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb me-1"></i>
                            è¯·æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç½‘ç»œæ˜¯å¦è¿é€šã€‚
                        </small>
                    </div>
                `;
                showAlert(`${type === 'webhook' ? 'Webhook' : 'é‚®ä»¶'}é€šçŸ¥æµ‹è¯•å¤±è´¥`, 'danger');
            }
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <h6 class="alert-heading mb-2"><i class="bi bi-x-circle me-2"></i>æµ‹è¯•å¤±è´¥</h6>
                    <p class="mb-0">${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                </div>
            `;
            showAlert('é€šçŸ¥æµ‹è¯•å¤±è´¥', 'danger');
        }
    } catch (error) {
        console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger mb-0">
                <h6 class="alert-heading mb-2"><i class="bi bi-x-circle me-2"></i>æµ‹è¯•å¤±è´¥</h6>
                <p class="mb-0">ç½‘ç»œé”™è¯¯: ${error.message}</p>
            </div>
        `;
        showAlert('é€šçŸ¥æµ‹è¯•å¤±è´¥: ç½‘ç»œé”™è¯¯', 'danger');
    } finally {
        // æ¢å¤æŒ‰é’®
        btn.disabled = false;
        if (type === 'webhook') {
            btn.innerHTML = '<i class="bi bi-send me-1"></i>æµ‹è¯• Webhook';
        } else {
            btn.innerHTML = '<i class="bi bi-send me-1"></i>æµ‹è¯•é‚®ä»¶';
        }
    }
}
</script>
{% endblock %}
