{% extends "base.html" %}
{% block title %}配置管理 - Bangumi Syncer{% endblock %}
{% block page_title %}配置管理{% endblock %}
{% block head %}{% endblock %}
{% block page_actions %}{% endblock %}
{% block content %}
    <form id="config-form">
        <!-- 同步配置 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4 config-card">
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-arrow-repeat me-2 text-success"></i>
                            <h6 class="m-0 fw-semibold">同步配置</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="sync-mode" class="form-label fw-semibold">
                                    <i class="bi bi-gear me-1 text-success"></i>同步模式
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="单用户模式：只同步一个用户\n多用户模式：同步多个用户"></i>
                                </label>
                                <select class="form-select form-select-lg"
                                        id="sync-mode"
                                        name="sync.mode"
                                        onchange="toggleSyncMode()">
                                    <option value="single">单用户模式</option>
                                    <option value="multi">多用户模式</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="single-username-container">
                                <label for="single-username" class="form-label fw-semibold">
                                    <i class="bi bi-person-check me-1 text-success"></i>单用户模式用户名
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="单用户模式用户名（Plex/Emby/Jellyfin中的用户名），用于跳过无需同步的用户提交的记录，只同步配置中的用户名产生的记录"></i>
                                </label>
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="single-username"
                                       name="sync.single_username"
                                       placeholder="输入媒体服务器用户名">
                            </div>
                            <div class="col-12">
                                <label for="blocked-keywords" class="form-label fw-semibold">
                                    <i class="bi bi-shield-x me-1 text-danger"></i>屏蔽关键词
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="屏蔽关键词列表，用逗号分隔。当番剧标题包含这些关键词时，将跳过同步处理。支持中文、英文、日文等多种语言的关键词"></i>
                                </label>
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="blocked-keywords"
                                       name="sync.blocked_keywords"
                                       placeholder="多个关键词用逗号分隔，如：物语系列,特典">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bangumi账号配置（单用户模式） -->
        <div class="row" id="single-user-bangumi-section">
            <div class="col-12">
                <div class="card shadow-sm mb-4 config-card">
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-circle me-2 text-primary"></i>
                            <h6 class="m-0 fw-semibold">Bangumi账号配置</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bangumi-username" class="form-label fw-semibold">
                                    <i class="bi bi-person me-1 text-primary"></i>用户名
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="Bangumi 的用户名或 UID。如果设置了用户名，只能填用户名。UID 就是个人资料页里 @123456 或者网址 bgm.tv/user/123456 的数字部分"></i>
                                </label>
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="bangumi-username"
                                       name="bangumi.username"
                                       placeholder="输入Bangumi用户名或UID">
                            </div>
                            <div class="col-md-6">
                                <label for="bangumi-access-token" class="form-label fw-semibold">
                                    <i class="bi bi-key me-1 text-primary"></i>访问令牌
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="令牌，注意有效期。生成网址：https://next.bgm.tv/demo/access-token"></i>
                                    <a href="https://next.bgm.tv/demo/access-token"
                                       target="_blank"
                                       class="btn btn-link btn-sm p-0 ms-2 text-decoration-none">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </label>
                                <div class="position-relative">
                                    <input type="password"
                                           class="form-control form-control-lg pe-5"
                                           id="bangumi-access-token"
                                           name="bangumi.access_token"
                                           placeholder="输入Bangumi访问令牌">
                                    <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 password-toggle-btn"
                                            type="button"
                                            id="toggle-token-visibility">
                                        <i class="bi bi-eye text-muted" id="token-visibility-icon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-eye-slash me-1 text-warning"></i>观看记录仅自己可见
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="观看记录是否仅自己可见。启用后观看记录只有自己能看到，不启用则为公开"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="bangumi-private"
                                           name="bangumi.private">
                                    <label class="form-check-label" for="bangumi-private">启用</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 多用户配置 -->
        <div class="row" id="multi-user-section" style="display: none;">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people me-2 text-secondary"></i>
                            <h6 class="m-0 fw-semibold">多用户配置</h6>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-primary"
                                onclick="addBangumiAccount()">
                            <i class="bi bi-plus-circle me-1"></i>添加Bangumi账号
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="bangumi-accounts-container">
                            <!-- 动态添加的Bangumi账号配置 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 高级配置 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-sliders me-2 text-info"></i>
                            <h6 class="m-0 fw-semibold">高级配置</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="script-proxy" class="form-label fw-semibold">
                                    <i class="bi bi-globe me-1 text-info"></i>HTTP代理
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="脚本的 HTTP 代理，例如 http://127.0.0.1:7890。若用 OpenClash 可能慢，原因未知，可尝试 CFW 或透明代理等"></i>
                                </label>
                                <div class="input-group">
                                    <input type="text"
                                           class="form-control form-control-lg"
                                           id="script-proxy"
                                           name="dev.script_proxy"
                                           placeholder="如：http://127.0.0.1:7890">
                                    <button class="btn btn-warning fw-bold"
                                            type="button"
                                            onclick="showProxyHelper()"
                                            title="智能代理配置助手 - 自动检测环境并推荐最佳配置"
                                            style="min-width: 120px">
                                        <i class="bi bi-magic me-1"></i>智能配置
                                    </button>
                                </div>
                                <div class="form-text mt-1">
                                    <i class="bi bi-lightbulb text-warning me-1"></i>
                                    <small class="text-muted">点击"智能配置"按钮获取适合您环境的代理配置建议</small>
                                </div>
                                <!-- 代理助手区域 -->
                                <div id="proxy-helper" class="mt-3" style="display: none;">
                                    <div class="card border-info">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-magic me-2 text-warning"></i>智能代理配置助手
                                                <small class="text-muted ms-2">支持Docker和本机环境</small>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- 端口号配置 -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-6">
                                                    <label for="proxy-port" class="form-label fw-semibold">
                                                        <i class="bi bi-hdd-network me-1"></i>代理端口号
                                                    </label>
                                                    <input type="number"
                                                           class="form-control"
                                                           id="proxy-port"
                                                           value="7890"
                                                           min="1"
                                                           max="65535"
                                                           onchange="updateProxySuggestions()"
                                                           placeholder="如：7890">
                                                </div>
                                                <div class="col-md-6 d-flex align-items-end">
                                                    <button type="button"
                                                            class="btn btn-outline-primary"
                                                            onclick="detectPortFromInput(event)">
                                                        <i class="bi bi-search me-1"></i>从HTTP代理输入框识别
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="proxy-suggestions" class="mb-3">
                                                <div class="text-center">
                                                    <div class="spinner-border spinner-border-sm text-info" role="status">
                                                        <span class="visually-hidden">检测中...</span>
                                                    </div>
                                                    <span class="ms-2">正在检测环境并生成建议...</span>
                                                </div>
                                            </div>
                                            <!-- 主机连通性测试区域 -->
                                            <div class="mt-3 border-top pt-3">
                                                <h6 class="text-primary mb-3">
                                                    <i class="bi bi-wifi me-2"></i>网络连通性测试
                                                    <small class="text-muted ms-2">验证容器是否能访问宿主机</small>
                                                </h6>
                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-4">
                                                        <label for="test-host" class="form-label">主机地址</label>
                                                        <input type="text"
                                                               class="form-control form-control-sm"
                                                               id="test-host"
                                                               placeholder="如：192.168.1.100"
                                                               value="">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="test-port" class="form-label">端口</label>
                                                        <input type="number"
                                                               class="form-control form-control-sm"
                                                               id="test-port"
                                                               value="7890"
                                                               min="1"
                                                               max="65535">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="test-timeout" class="form-label">超时(秒)</label>
                                                        <input type="number"
                                                               class="form-control form-control-sm"
                                                               id="test-timeout"
                                                               value="5"
                                                               min="1"
                                                               max="30">
                                                    </div>
                                                    <div class="col-md-2 d-flex align-items-end">
                                                        <button type="button"
                                                                class="btn btn-primary btn-sm w-100"
                                                                onclick="testHostConnectivity()"
                                                                id="test-host-btn">
                                                            <i class="bi bi-play-circle me-1"></i>测试
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="host-test-result" class="mb-3" style="display: none;">
                                                    <!-- 测试结果将显示在这里 -->
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    点击建议的代理地址可自动填入，可自定义端口号重新生成建议
                                                </small>
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-secondary"
                                                        onclick="hideProxyHelper()">关闭</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-shield-check me-1 text-success"></i>SSL证书验证
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="SSL证书验证。当使用代理时可能需要关闭。注意：关闭SSL验证会降低安全性，仅在代理环境下出现SSL错误时使用"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="ssl-verify"
                                           name="dev.ssl_verify">
                                    <label class="form-check-label" for="ssl-verify">启用SSL验证</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-bug me-1 text-warning"></i>调试模式
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="是否开启debug模式，一般不用开。开启后会输出详细的调试信息"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="debug-mode"
                                           name="dev.debug">
                                    <label class="form-check-label" for="debug-mode">启用调试模式</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Web认证配置 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-lock me-2 text-danger"></i>
                            <h6 class="m-0 fw-semibold">Web认证配置</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-shield-check me-1 text-success"></i>启用Web认证
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="是否启用Web管理界面认证，建议在外网环境下启用。禁用后任何人都可以访问管理界面"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="auth-enabled"
                                           name="auth.enabled">
                                    <label class="form-check-label" for="auth-enabled">启用</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="auth-username" class="form-label fw-semibold">
                                    <i class="bi bi-person me-1 text-primary"></i>管理员用户名
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="Web管理界面的登录用户名"></i>
                                </label>
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="auth-username"
                                       name="auth.username"
                                       placeholder="admin">
                            </div>
                            <div class="col-md-3">
                                <label for="auth-password" class="form-label fw-semibold">
                                    <i class="bi bi-key me-1 text-warning"></i>管理员密码
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="Web管理界面的登录密码。留空表示不修改当前密码"></i>
                                </label>
                                <div class="position-relative">
                                    <input type="password"
                                           class="form-control form-control-lg pe-5"
                                           id="auth-password"
                                           name="auth.password"
                                           placeholder="留空表示不修改密码">
                                    <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 password-toggle-btn"
                                            type="button"
                                            id="toggle-auth-password-visibility">
                                        <i class="bi bi-eye text-muted" id="auth-password-visibility-icon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="session-timeout" class="form-label fw-semibold">
                                    <i class="bi bi-clock me-1 text-info"></i>会话超时时间
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="登录会话的超时时间（秒），默认3600秒（1小时）"></i>
                                </label>
                                <input type="number"
                                       class="form-control form-control-lg"
                                       id="session-timeout"
                                       name="auth.session_timeout"
                                       placeholder="3600"
                                       min="300"
                                       max="86400">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-shield-lock me-1 text-success"></i>启用HTTPS安全Cookie
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="启用后Cookie只在HTTPS连接下传输，提高安全性。仅在使用HTTPS时启用"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="https-only"
                                           name="auth.https_only">
                                    <label class="form-check-label" for="https-only">启用</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="max-login-attempts" class="form-label fw-semibold">
                                    <i class="bi bi-shield-x me-1 text-warning"></i>最大登录尝试次数
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="单个IP地址的最大登录失败次数，超过后将被锁定"></i>
                                </label>
                                <input type="number"
                                       class="form-control form-control-lg"
                                       id="max-login-attempts"
                                       name="auth.max_login_attempts"
                                       placeholder="5"
                                       min="1"
                                       max="20">
                            </div>
                            <div class="col-md-3">
                                <label for="lockout-duration" class="form-label fw-semibold">
                                    <i class="bi bi-clock-history me-1 text-danger"></i>锁定时间（秒）
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="IP被锁定的时间长度（秒），默认900秒（15分钟）"></i>
                                </label>
                                <input type="number"
                                       class="form-control form-control-lg"
                                       id="lockout-duration"
                                       name="auth.lockout_duration"
                                       placeholder="900"
                                       min="60"
                                       max="86400">
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>安全提醒：</strong>在外网环境下强烈建议启用认证功能。修改密码后需要重新登录。
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bangumi-data配置 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4 config-card">
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hdd-stack me-2 text-primary"></i>
                            <h6 class="m-0 fw-semibold">Bangumi-data配置</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-search me-1 text-success"></i>使用Bangumi-data匹配
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="是否启用 bangumi-data 匹配。启用后会先尝试通过 bangumi-data 匹配番剧ID，匹配成功后可以减少API请求次数"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="bangumi-data-enabled"
                                           name="bangumi_data.enabled">
                                    <label class="form-check-label" for="bangumi-data-enabled">启用</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-hdd me-1 text-primary"></i>使用本地缓存
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="是否使用本地缓存文件，默认启用。启用后会将下载的数据保存到本地，之后再次启动时优先使用缓存"></i>
                                </label>
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-2"
                                           type="checkbox"
                                           id="bangumi-data-cache"
                                           name="bangumi_data.use_cache">
                                    <label class="form-check-label" for="bangumi-data-cache">启用</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="cache-ttl" class="form-label fw-semibold">
                                    <i class="bi bi-clock me-1 text-warning"></i>缓存有效期（天）
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="缓存有效期（天），超过此时间后会自动更新缓存。设置为0表示每次启动都会更新缓存"></i>
                                </label>
                                <input type="number"
                                       class="form-control form-control-lg"
                                       id="cache-ttl"
                                       name="bangumi_data.cache_ttl_days"
                                       placeholder="7"
                                       min="0"
                                       max="365">
                            </div>
                        </div>
                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="data-url" class="form-label fw-semibold">
                                    <i class="bi bi-link me-1 text-info"></i>数据源URL
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="bangumi-data数据源的URL地址，默认使用官方CDN地址。如果官方地址无法访问，可以替换为其他镜像地址"></i>
                                </label>
                                <input type="url"
                                       class="form-control form-control-lg"
                                       id="data-url"
                                       name="bangumi_data.data_url"
                                       placeholder="https://unpkg.com/bangumi-data@0.3/dist/data.json">
                            </div>
                            <div class="col-md-6">
                                <label for="local-cache-path" class="form-label fw-semibold">
                                    <i class="bi bi-folder me-1 text-secondary"></i>本地缓存路径
                                    <i class="bi bi-question-circle ms-1 text-muted"
                                       data-bs-toggle="tooltip"
                                       title="bangumi-data本地缓存文件的存储路径，默认为当前目录下的bangumi_data_cache.json文件"></i>
                                </label>
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="local-cache-path"
                                       name="bangumi_data.local_cache_path"
                                       placeholder="./bangumi_data_cache.json">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 通知配置 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4 config-card">
                    <div class="card-header py-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-bell me-2 text-warning"></i>
                                <h6 class="m-0 fw-semibold">通知配置</h6>
                            </div>
                            <button type="button"
                                    class="btn btn-primary btn-sm"
                                    onclick="showAddWebhookModal()">
                                <i class="bi bi-plus-lg me-1"></i>添加 Webhook 配置
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Webhook 配置列表 -->
                        <div id="webhook-configs-container">
                            <div class="text-center py-5">
                                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3">暂无 Webhook 配置</p>
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        onclick="showAddWebhookModal()">
                                    <i class="bi bi-plus-lg me-1"></i>添加第一个配置
                                </button>
                            </div>
                        </div>
                        <hr class="my-4">
                        <!-- 邮件通知配置 -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope text-success me-2"></i>
                                <h6 class="m-0 fw-semibold">邮件通知配置</h6>
                            </div>
                            <button type="button"
                                    class="btn btn-success btn-sm"
                                    onclick="showAddEmailModal()">
                                <i class="bi bi-plus-lg me-1"></i>添加邮件配置
                            </button>
                        </div>
                        <!-- 邮件配置列表 -->
                        <div id="email-configs-container">
                            <div class="text-center py-5">
                                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3">暂无邮件配置</p>
                                <button type="button"
                                        class="btn btn-outline-success"
                                        onclick="showAddEmailModal()">
                                    <i class="bi bi-plus-lg me-1"></i>添加第一个配置
                                </button>
                            </div>
                        </div>
                        <div class="alert alert-info mt-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>提示：</strong>配置完成后，也可以在「调试工具」页面测试全部通知项功能。特定事件发生时会自动发送通知（60秒冷却时间）。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- 操作按钮 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-gear me-2 text-primary"></i>
                        <h6 class="m-0 fw-semibold">配置操作</h6>
                    </div>
                </div>
                <div class="card-body text-center py-4">
                    <div class="btn-group me-3" role="group">
                        <button type="button" class="btn btn-primary px-4" onclick="saveConfig()">
                            <i class="bi bi-save me-2"></i>保存配置
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary px-4"
                                onclick="loadConfig(true)">
                            <i class="bi bi-arrow-clockwise me-2"></i>重新加载
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button"
                                class="btn btn-outline-info px-4"
                                onclick="backupConfig()">
                            <i class="bi bi-download me-2"></i>备份配置
                        </button>
                        <button type="button"
                                class="btn btn-outline-warning px-4"
                                onclick="showRestoreModal()">
                            <i class="bi bi-upload me-2"></i>恢复配置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 调试工具导航 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4 border-info border-opacity-25">
                <div class="card-body text-center py-4">
                    <div class="mb-3">
                        <i class="bi bi-bug display-4 text-info"></i>
                    </div>
                    <h5 class="card-title text-info mb-3">需要测试同步功能？</h5>
                    <p class="card-text text-muted mb-4">
                        测试同步和网络诊断功能已移至专门的调试工具页面，
                        <br>
                        提供更丰富的调试功能和更好的用户体验。
                    </p>
                    <a href="/debug" class="btn btn-info px-4">
                        <i class="bi bi-arrow-right-circle me-2"></i>前往调试工具
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- 恢复配置模态框 -->
    <div class="modal fade"
         id="restoreConfigModal"
         tabindex="-1"
         aria-labelledby="restoreConfigModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restoreConfigModalLabel">
                        <i class="bi bi-upload me-2"></i>恢复配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-semibold mb-0">
                                    <i class="bi bi-clock-history me-1"></i>选择备份文件
                                </h6>
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm"
                                        onclick="showCleanupModal()">
                                    <i class="bi bi-trash me-1"></i>清理备份
                                </button>
                            </div>
                            <div class="list-group" id="backup-files-list">
                                <div class="text-center p-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">正在加载备份文件...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-semibold mb-3">
                                <i class="bi bi-eye me-1"></i>配置预览
                            </h6>
                            <div id="config-preview"
                                 class="border rounded p-3"
                                 style="height: 300px;
                                        overflow-y: auto;
                                        background-color: #f8f9fa">
                                <p class="text-muted mb-0">选择左侧的备份文件以预览配置内容</p>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>注意：</strong>恢复配置将覆盖当前所有配置，请确保已备份当前配置。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button"
                            class="btn btn-warning"
                            id="restore-confirm-btn"
                            onclick="confirmRestore()"
                            disabled>
                        <i class="bi bi-check-circle me-1"></i>确认恢复
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 清理备份模态框 -->
    <div class="modal fade"
         id="cleanupBackupModal"
         tabindex="-1"
         aria-labelledby="cleanupBackupModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cleanupBackupModalLabel">
                        <i class="bi bi-trash me-2"></i>清理备份文件
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>清理策略：</strong>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="cleanupStrategy"
                                       id="keepRecent"
                                       value="recent"
                                       checked>
                                <label class="form-check-label" for="keepRecent">
                                    <strong>保留最近的备份</strong>
                                    <br>
                                    <small class="text-muted">保留最近的几个备份文件</small>
                                </label>
                            </div>
                            <div class="mt-2 ms-4">
                                <label for="keepCount" class="form-label">保留数量：</label>
                                <select class="form-select form-select-sm" id="keepCount">
                                    <option value="3">3个</option>
                                    <option value="5" selected>5个</option>
                                    <option value="10">10个</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="cleanupStrategy"
                                       id="keepByDate"
                                       value="date">
                                <label class="form-check-label" for="keepByDate">
                                    <strong>按日期清理</strong>
                                    <br>
                                    <small class="text-muted">删除指定天数前的备份</small>
                                </label>
                            </div>
                            <div class="mt-2 ms-4">
                                <label for="keepDays" class="form-label">保留天数：</label>
                                <select class="form-select form-select-sm" id="keepDays">
                                    <option value="7">7天</option>
                                    <option value="30" selected>30天</option>
                                    <option value="90">90天</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="radio"
                                   name="cleanupStrategy"
                                   id="deleteAll"
                                   value="all">
                            <label class="form-check-label" for="deleteAll">
                                <strong class="text-danger">删除所有备份</strong>
                                <br>
                                <small class="text-muted">删除所有备份文件（慎用）</small>
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>注意：</strong>此操作不可逆，请确保已经确认要删除的备份文件。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="confirmCleanup()">
                        <i class="bi bi-trash me-1"></i>确认清理
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
// 全局变量
let bangumiAccountCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 初始化令牌显示/隐藏功能
    document.getElementById('toggle-token-visibility').addEventListener('click', function() {
        const tokenInput = document.getElementById('bangumi-access-token');
        const icon = document.getElementById('token-visibility-icon');
        
        if (tokenInput.type === 'password') {
            tokenInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            tokenInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });
    
    // 初始化认证密码显示/隐藏功能
    document.getElementById('toggle-auth-password-visibility').addEventListener('click', function() {
        const passwordInput = document.getElementById('auth-password');
        const icon = document.getElementById('auth-password-visibility-icon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });

    // 初始化模态框
    const modalElement = document.getElementById('restoreConfigModal');
    if (modalElement) {
        try {
            restoreConfigModal = new bootstrap.Modal(modalElement);
            console.log('恢复配置模态框初始化成功');
        } catch (error) {
            console.error('模态框初始化失败:', error);
        }
    } else {
        console.error('找不到恢复配置模态框元素');
    }
    loadConfig(false); // 初始加载时不显示提示
});

async function loadConfig(showToast = true) {
    try {
        const response = await fetch('/api/config', {
            method: 'GET',
            credentials: 'include',  // 包含Cookie认证信息
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 401) {
            // 认证失败，跳转到登录页面
            window.location.href = '/login';
            return;
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            currentConfig = data.data;
            populateForm(currentConfig);
            // 加载通知配置
            loadWebhookConfigs();
            loadEmailConfigs();
            if (showToast) {
                showAlert('配置重新加载成功', 'success');
            }
        } else {
            showAlert('加载配置失败: ' + (data.message || '未知错误'), 'danger');
        }
    } catch (error) {
        console.error('加载配置失败:', error);
        showAlert('加载配置失败: ' + error.message, 'danger');
    }
}

function populateForm(config) {
    // 填充基本配置
    document.getElementById('bangumi-username').value = config.bangumi.username || '';
    document.getElementById('bangumi-access-token').value = config.bangumi.access_token || '';
    document.getElementById('bangumi-private').checked = config.bangumi.private || false;
    
    document.getElementById('sync-mode').value = config.sync.mode || 'single';
    document.getElementById('single-username').value = config.sync.single_username || '';
    document.getElementById('blocked-keywords').value = config.sync.blocked_keywords || '';
    
    document.getElementById('script-proxy').value = config.dev.script_proxy || '';
    document.getElementById('ssl-verify').checked = Boolean(config.dev.ssl_verify);
    document.getElementById('debug-mode').checked = Boolean(config.dev.debug);
    
    document.getElementById('bangumi-data-enabled').checked = config.bangumi_data.enabled !== false;
    document.getElementById('bangumi-data-cache').checked = config.bangumi_data.use_cache !== false;
    document.getElementById('cache-ttl').value = config.bangumi_data.cache_ttl_days || 7;
    document.getElementById('data-url').value = config.bangumi_data.data_url || 'https://unpkg.com/bangumi-data@0.3/dist/data.json';
    document.getElementById('local-cache-path').value = config.bangumi_data.local_cache_path || './bangumi_data_cache.json';
    
    // 填充认证配置
    if (config.auth) {
        document.getElementById('auth-enabled').checked = config.auth.enabled !== false;
        document.getElementById('auth-username').value = config.auth.username || 'admin';
        document.getElementById('session-timeout').value = config.auth.session_timeout || 3600;
        document.getElementById('https-only').checked = config.auth.https_only || false;
        document.getElementById('max-login-attempts').value = config.auth.max_login_attempts || 5;
        document.getElementById('lockout-duration').value = config.auth.lockout_duration || 900;
        // 密码字段留空，表示不修改
        document.getElementById('auth-password').value = '';
    }

    // 切换同步模式
    toggleSyncMode();
    
    // 填充多用户配置
    if (config.sync.mode === 'multi') {
        populateMultiUserConfig(config.multi_accounts, config.user_mappings);
    }
}

function toggleSyncMode() {
    const mode = document.getElementById('sync-mode').value;
    const singleContainer = document.getElementById('single-username-container');
    const singleBangumiSection = document.getElementById('single-user-bangumi-section');
    const multiSection = document.getElementById('multi-user-section');
    
    if (mode === 'single') {
        // 单用户模式：显示单用户名输入框和Bangumi账号配置，隐藏多用户配置
        singleContainer.style.display = 'block';
        singleBangumiSection.style.display = 'block';
        multiSection.style.display = 'none';
    } else {
        // 多用户模式：隐藏单用户名输入框和Bangumi账号配置，显示多用户配置
        singleContainer.style.display = 'none';
        singleBangumiSection.style.display = 'none';
        multiSection.style.display = 'block';
    }
}

function populateMultiUserConfig(accounts, mappings) {
    const accountsContainer = document.getElementById('bangumi-accounts-container');
    
    accountsContainer.innerHTML = '';
    
    // 重置全局计数器
    bangumiAccountCounter = 0;
    
    // 添加Bangumi账号
    Object.entries(accounts || {}).forEach(([key, account]) => {
        // 使用display_name作为显示名称，如果没有则使用配置段名
        const displayName = account.display_name || key;
        addBangumiAccount(displayName, account);
    });
    
}

function addBangumiAccount(accountName = '', accountConfig = {}) {
    const container = document.getElementById('bangumi-accounts-container');
    const id = bangumiAccountCounter++;
    
    const accountDiv = document.createElement('div');
    accountDiv.className = 'border rounded p-3 mb-3';
    accountDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Bangumi账号 ${id + 1}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBangumiAccount(${id})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">账号备注</label>
                <input type="text" class="form-control bangumi-account-name" value="${accountName}" placeholder="用户昵称或备注">
            </div>
            <div class="col-md-3">
                <label class="form-label">Bangumi用户名</label>
                <input type="text" class="form-control bangumi-account-username" value="${accountConfig.username || ''}" placeholder="Bangumi用户名">
            </div>
            <div class="col-md-3">
                <label class="form-label">媒体服务器用户名</label>
                <input type="text" class="form-control bangumi-account-media-username" value="${accountConfig.media_server_username || ''}" placeholder="Plex/Emby/Jellyfin用户名">
            </div>
            <div class="col-md-3">
                <label class="form-label">访问令牌</label>
                <input type="password" class="form-control bangumi-account-token" value="${accountConfig.access_token || ''}" placeholder="访问令牌">
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input bangumi-account-private" type="checkbox" ${accountConfig.private ? 'checked' : ''}>
                    <label class="form-check-label">观看记录仅自己可见</label>
                </div>
            </div>
        </div>
    `;
    
    accountDiv.id = `bangumi-account-${id}`;
    container.appendChild(accountDiv);
}

function removeBangumiAccount(id) {
    const element = document.getElementById(`bangumi-account-${id}`);
    if (element) {
        element.remove();
    }
}

async function saveConfig() {
    try {
        const configData = {
            bangumi: {
                username: document.getElementById('bangumi-username').value,
                access_token: document.getElementById('bangumi-access-token').value,
                private: document.getElementById('bangumi-private').checked
            },
            sync: {
                mode: document.getElementById('sync-mode').value,
                single_username: document.getElementById('single-username').value,
                blocked_keywords: document.getElementById('blocked-keywords').value
            },
            dev: {
                script_proxy: document.getElementById('script-proxy').value,
                ssl_verify: document.getElementById('ssl-verify').checked,
                debug: document.getElementById('debug-mode').checked
            },
            bangumi_data: {
                enabled: document.getElementById('bangumi-data-enabled').checked,
                use_cache: document.getElementById('bangumi-data-cache').checked,
                cache_ttl_days: parseInt(document.getElementById('cache-ttl').value),
                data_url: document.getElementById('data-url').value,
                local_cache_path: document.getElementById('local-cache-path').value
            },
            auth: {
                enabled: document.getElementById('auth-enabled').checked,
                username: document.getElementById('auth-username').value,
                session_timeout: parseInt(document.getElementById('session-timeout').value) || 3600,
                https_only: document.getElementById('https-only').checked,
                max_login_attempts: parseInt(document.getElementById('max-login-attempts').value) || 5,
                lockout_duration: parseInt(document.getElementById('lockout-duration').value) || 900
            }
        };
        
        // 如果密码字段不为空，则添加到配置中
        const authPassword = document.getElementById('auth-password').value;
        if (authPassword.trim() !== '') {
            configData.auth.password = authPassword;
        }
        
        // 处理多用户配置
        if (configData.sync.mode === 'multi') {
            const multiAccounts = {};
            const userMappings = {};
            
            // 收集Bangumi账号
            document.querySelectorAll('[id^="bangumi-account-"]').forEach((element, index) => {
                const displayName = element.querySelector('.bangumi-account-name').value;
                const username = element.querySelector('.bangumi-account-username').value;
                const mediaUsername = element.querySelector('.bangumi-account-media-username').value;
                const token = element.querySelector('.bangumi-account-token').value;
                const isPrivate = element.querySelector('.bangumi-account-private').checked;
                
                if (username && mediaUsername && token) {
                    // 使用索引生成唯一的键名，实际的配置段名会在后端自动生成
                    const accountKey = displayName || `account_${index + 1}`;
                    multiAccounts[accountKey] = {
                        username: username,
                        access_token: token,
                        media_server_username: mediaUsername,
                        private: isPrivate
                    };
                }
            });
            
            configData.multi_accounts = multiAccounts;
        }
        
        const response = await fetch('/api/config', {
            method: 'POST',
            credentials: 'include',  // 包含Cookie认证信息
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('配置保存成功', 'success');
            
            // 如果修改了密码，提示需要重新登录
            if (authPassword.trim() !== '') {
                setTimeout(() => {
                    if (confirm('您已修改了登录密码，需要重新登录。是否现在跳转到登录页面？')) {
                        // 先登出，然后跳转到登录页面
                        fetch('/api/logout', {
                            method: 'POST',
                            credentials: 'include'
                        }).then(() => {
                            window.location.href = '/login';
                        });
                    }
                }, 1000);
            }
        } else {
            showAlert('配置保存失败: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('保存配置失败:', error);
        showAlert('保存配置失败', 'danger');
    }
}


// 备份配置
async function backupConfig() {
    try {
        const response = await fetch('/api/config/backup', {
            method: 'POST',
            credentials: 'include',  // 包含Cookie认证信息
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('配置备份成功，已保存到服务器', 'success');
            // 刷新备份文件列表
            await loadBackupFiles();
        } else {
            showAlert('备份配置失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('备份配置失败:', error);
        showAlert('备份配置失败', 'danger');
    }
}

// 显示恢复配置模态框
async function showRestoreModal() {
    console.log('尝试显示恢复配置模态框');
    
    // 确保模态框已初始化
    if (!restoreConfigModal) {
        console.log('模态框未初始化，尝试重新初始化');
        const modalElement = document.getElementById('restoreConfigModal');
        if (modalElement) {
            try {
                restoreConfigModal = new bootstrap.Modal(modalElement);
                console.log('模态框重新初始化成功');
            } catch (error) {
                console.error('模态框初始化失败:', error);
                showAlert('恢复配置功能初始化失败', 'danger');
                return;
            }
        } else {
            console.error('找不到模态框元素');
            showAlert('恢复配置功能暂不可用', 'warning');
            return;
        }
    }
    
    try {
        restoreConfigModal.show();
        console.log('模态框显示成功');
        await loadBackupFiles();
    } catch (error) {
        console.error('显示模态框失败:', error);
        showAlert('无法显示恢复配置对话框', 'danger');
    }
}

// 加载备份文件列表
async function loadBackupFiles() {
    try {
        const response = await fetch('/api/config/backups', {
            credentials: 'include'
        });
        const data = await response.json();
        
        const backupFilesList = document.getElementById('backup-files-list');
        backupFilesList.innerHTML = '';
        
        if (data.status === 'success' && data.data.backups.length > 0) {
            data.data.backups.forEach(backup => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1 me-3" onclick="selectBackupFile('${backup.filename}')" style="cursor: pointer;">
                            <h6 class="mb-1">${backup.filename}</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${backup.created}</small>
                                <small class="text-muted">大小: ${(backup.size / 1024).toFixed(2)} KB</small>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteBackupFile('${backup.filename}', event)" title="删除备份">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                backupFilesList.appendChild(item);
            });
        } else {
            backupFilesList.innerHTML = `
                <div class="text-center p-3">
                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0 text-muted">暂无备份文件</p>
                    <small class="text-muted">点击"备份配置"创建第一个备份</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('加载备份文件失败:', error);
        document.getElementById('backup-files-list').innerHTML = `
            <div class="text-center p-3">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0 text-muted">加载备份文件失败</p>
            </div>
        `;
    }
}

// 选择备份文件
async function selectBackupFile(filename) {
    // 更新选中状态
    document.querySelectorAll('#backup-files-list .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');
    
    // 找到对应的backup对象
    const response = await fetch('/api/config/backups', {
        credentials: 'include'
    });
    const data = await response.json();
    const backup = data.data.backups.find(b => b.filename === filename);
    
    selectedBackupFile = backup;
    document.getElementById('restore-confirm-btn').disabled = false;
    
    // 预览配置内容
    try {
        const response = await fetch(`/api/config/backup/${filename}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            const preview = document.getElementById('config-preview');
            preview.innerHTML = `<pre class="mb-0">${data.data.content}</pre>`;
        } else {
            document.getElementById('config-preview').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    无法预览配置文件: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('预览配置失败:', error);
        document.getElementById('config-preview').innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                预览配置失败
            </div>
        `;
    }
}

// 删除单个备份文件
async function deleteBackupFile(filename, event) {
    event.stopPropagation(); // 阻止事件冒泡
    
    if (!confirm('确定要删除这个备份文件吗？此操作不可逆。')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/config/backup/${filename}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('备份文件删除成功', 'success');
            // 刷新备份文件列表
            await loadBackupFiles();
            
            // 如果删除的是当前选中的文件，清空预览
            if (selectedBackupFile && selectedBackupFile.filename === filename) {
                selectedBackupFile = null;
                document.getElementById('restore-confirm-btn').disabled = true;
                document.getElementById('config-preview').innerHTML = `
                    <p class="text-muted mb-0">选择左侧的备份文件以预览配置内容</p>
                `;
            }
        } else {
            showAlert('删除备份文件失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('删除备份文件失败:', error);
        showAlert('删除备份文件失败', 'danger');
    }
}

// 确认恢复配置
async function confirmRestore() {
    if (!selectedBackupFile) {
        showAlert('请选择要恢复的备份文件', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/config/restore/${selectedBackupFile.filename}`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            if (restoreConfigModal) {
                restoreConfigModal.hide();
            }
            showAlert('配置已恢复，正在重新加载...', 'success');
            
            // 延迟重新加载配置
            setTimeout(() => {
                loadConfig(true);
                // 恢复成功后提醒用户保存配置
                setTimeout(() => {
                    showAlert('配置已恢复成功！请记得点击"保存配置"按钮保存当前设置，避免丢失恢复的配置。', 'warning', 8000);
                }, 1500);
            }, 1000);
        } else {
            showAlert('恢复配置失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('恢复配置失败:', error);
        showAlert('恢复配置失败', 'danger');
    }
}

// 显示清理备份模态框
function showCleanupModal() {
    const cleanupModal = new bootstrap.Modal(document.getElementById('cleanupBackupModal'));
    cleanupModal.show();
}

// 显示代理助手
async function showProxyHelper() {
    const helperDiv = document.getElementById('proxy-helper');
    helperDiv.style.display = 'block';
    
    // 尝试从当前输入框检测端口号
    detectPortFromInput();
    
    // 获取代理建议
    await loadProxySuggestions();
}

// 从输入框检测端口号
function detectPortFromInput(event) {
    // 阻止事件冒泡和默认行为
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const proxyInput = document.getElementById('script-proxy').value.trim();
    const portInput = document.getElementById('proxy-port');
    
    if (!proxyInput) {
        showAlert('代理输入框为空，请先填写代理地址', 'warning', 3000);
        return;
    }
    
    // 尝试从URL中提取端口号，支持多种格式
    const portPatterns = [
        /:(\d+)(?:\/|$)/,           // http://127.0.0.1:7890 或 http://127.0.0.1:7890/
        /:(\d+)(?:\?|#|$)/,         // http://127.0.0.1:7890?param=value
        /127\.0\.0\.1:(\d+)/,       // 127.0.0.1:7890
        /localhost:(\d+)/,          // localhost:7890
        /172\.17\.0\.1:(\d+)/,      // 172.17.0.1:7890
        /host\.docker\.internal:(\d+)/, // host.docker.internal:7890
        /192\.168\.\d+\.\d+:(\d+)/  // 192.168.x.x:7890
    ];
    
    let detectedPort = null;
    
    for (const pattern of portPatterns) {
        const match = proxyInput.match(pattern);
        if (match && match[1]) {
            const port = parseInt(match[1]);
            if (port >= 1 && port <= 65535) {
                detectedPort = port;
                break;
            }
        }
    }
    
    if (detectedPort) {
        portInput.value = detectedPort;
        showAlert(`✅ 已从输入框检测到端口号: ${detectedPort}`, 'success', 3000);
        // 自动更新建议
        updateProxySuggestions();
    } else {
        showAlert('❌ 未能从输入框检测到有效端口号，请检查格式或手动输入', 'warning', 4000);
        // 聚焦到端口输入框
        portInput.focus();
    }
}

        // 更新代理建议
        async function updateProxySuggestions() {
            await loadProxySuggestions();
        }
        
        // 测试主机连通性
        async function testHostConnectivity() {
            const hostInput = document.getElementById('test-host');
            const portInput = document.getElementById('test-port');
            const timeoutInput = document.getElementById('test-timeout');
            const testBtn = document.getElementById('test-host-btn');
            const resultDiv = document.getElementById('host-test-result');
            
            const host = hostInput.value.trim();
            const port = parseInt(portInput.value) || 7890;
            const timeout = parseInt(timeoutInput.value) || 5;
            
            if (!host) {
                showAlert('请输入主机地址', 'warning', 3000);
                hostInput.focus();
                return;
            }
            
            // 显示测试中状态
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>测试中...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        <span>正在测试连接到 ${host}:${port}...</span>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/proxy/test-host', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: host,
                        port: port,
                        timeout: timeout
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayHostTestResult(data.data, host, port);
                } else {
                    showHostTestError('测试失败: ' + data.message);
                }
                
            } catch (error) {
                console.error('主机连通性测试失败:', error);
                showHostTestError('网络错误，无法执行连通性测试');
            } finally {
                // 恢复按钮状态
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i>测试';
            }
        }
        
        // 显示主机测试结果
        function displayHostTestResult(result, host, port) {
            const resultDiv = document.getElementById('host-test-result');
            
            let html = '';
            
            if (result.success) {
                html = `
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle me-2"></i>
                            连接成功！
                        </h6>
                        <p class="mb-2">
                            <strong>目标：</strong>${host}:${port}<br>
                            <strong>响应时间：</strong>${result.response_time}ms
                        </p>
                        <hr>
                        <p class="mb-0 small text-success">
                            <i class="bi bi-info-circle me-1"></i>
                            容器可以访问到宿主机的这个地址和端口，代理配置应该可以正常工作。
                        </p>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="bi bi-x-circle me-2"></i>
                            连接失败
                        </h6>
                        <p class="mb-2">
                            <strong>目标：</strong>${host}:${port}<br>
                            <strong>错误：</strong>${result.error}
                        </p>
                `;
                
                // 添加详细的测试结果
                if (result.details) {
                    html += '<hr><h6 class="small">详细测试结果：</h6>';
                    
                    if (result.details.tcp_test) {
                        const tcpTest = result.details.tcp_test;
                        const tcpIcon = tcpTest.success ? 'check-circle text-success' : 'x-circle text-danger';
                        html += `
                            <p class="small mb-1">
                                <i class="bi bi-${tcpIcon} me-1"></i>
                                <strong>TCP连接：</strong>${tcpTest.success ? '成功' : tcpTest.error}
                            </p>
                        `;
                    }
                    
                    if (result.details.ping_test) {
                        const pingTest = result.details.ping_test;
                        const pingIcon = pingTest.success ? 'check-circle text-success' : 'x-circle text-warning';
                        html += `
                            <p class="small mb-1">
                                <i class="bi bi-${pingIcon} me-1"></i>
                                <strong>Ping测试：</strong>${pingTest.success ? '成功' : pingTest.error}
                            </p>
                        `;
                    }
                }
                
                html += `
                        <hr>
                        <p class="mb-0 small text-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            容器无法访问到宿主机的这个地址和端口，请检查：<br>
                            1. 宿主机IP地址是否正确<br>
                            2. 代理服务是否正在运行<br>
                            3. 防火墙是否允许连接<br>
                            4. 代理是否允许来自Docker网段的连接
                        </p>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        // 显示主机测试错误
        function showHostTestError(message) {
            const resultDiv = document.getElementById('host-test-result');
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6 class="alert-heading">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        测试异常
                    </h6>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }

// 加载代理建议
async function loadProxySuggestions() {
    const portInput = document.getElementById('proxy-port');
    const port = parseInt(portInput.value) || 7890;
    
    try {
        // 获取代理建议
        const response = await fetch(`/api/proxy/suggestions?port=${port}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            displayProxySuggestions(data.data);
        } else {
            showProxyError('获取代理建议失败: ' + data.message);
        }
    } catch (error) {
        console.error('获取代理建议失败:', error);
        showProxyError('网络错误，无法获取代理建议');
    }
}

// 隐藏代理助手
function hideProxyHelper() {
    document.getElementById('proxy-helper').style.display = 'none';
}

// 显示代理建议
function displayProxySuggestions(data) {
    const suggestionsDiv = document.getElementById('proxy-suggestions');
    
    if (!data.suggestions || data.suggestions.length === 0) {
        suggestionsDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                未找到合适的代理配置建议
            </div>
        `;
        return;
    }
    
    const currentPort = document.getElementById('proxy-port').value;
    
    let html = `
        <div class="mb-3">
            <h6 class="text-info">
                <i class="bi bi-info-circle me-2"></i>
                检测到环境: ${data.environment.is_docker ? 'Docker容器' : '本机环境'}
                ${data.environment.is_docker ? `(${data.environment.network_mode}模式)` : '(原生运行)'}
            </h6>
            <p class="small text-muted mb-0">
                ${data.environment.is_docker ? 
                    `已为Docker环境优化代理配置建议，使用端口: ${currentPort}` : 
                    `已为本机环境提供常用代理配置，使用端口: ${currentPort}`}
            </p>
        </div>
        <div class="row g-2">
    `;
    
    data.suggestions.forEach((suggestion, index) => {
        const badgeClass = index === 0 ? 'bg-success' : 'bg-info';
        const recommendText = index === 0 ? '推荐' : '';
        
        html += `
            <div class="col-12">
                <div class="card border-light proxy-suggestion" onclick="selectProxy('${suggestion.address}')" style="cursor: pointer;">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <code class="text-primary">${suggestion.address}</code>
                                <small class="text-muted d-block">${suggestion.description}</small>
                            </div>
                            <div>
                                ${recommendText ? `<span class="badge ${badgeClass}">${recommendText}</span>` : ''}
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="testProxy('${suggestion.address}', event)">
                                    <i class="bi bi-wifi"></i> 测试
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    suggestionsDiv.innerHTML = html;
}

// 显示代理错误
function showProxyError(message) {
    const suggestionsDiv = document.getElementById('proxy-suggestions');
    suggestionsDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// 选择代理
function selectProxy(address) {
    document.getElementById('script-proxy').value = address;
    showAlert('代理地址已填入，记得保存配置', 'success', 3000);
}

// 测试代理连通性
async function testProxy(address, event) {
    event.stopPropagation(); // 阻止冒泡
    
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    // 显示测试状态
    button.disabled = true;
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
    
    try {
        const response = await fetch('/api/proxy/test', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ proxy_url: address })
        });
        
        const data = await response.json();
        
        if (data.status === 'success' && data.data.success) {
            button.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
            showAlert(`代理测试成功 (${data.data.response_time}ms)`, 'success', 3000);
        } else {
            button.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
            showAlert(`代理测试失败: ${data.data.error}`, 'warning', 5000);
        }
    } catch (error) {
        button.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
        showAlert('代理测试失败: 网络错误', 'danger', 5000);
    }
    
    // 3秒后恢复按钮
    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }, 3000);
}

// 确认清理备份
async function confirmCleanup() {
    const strategy = document.querySelector('input[name="cleanupStrategy"]:checked').value;
    let params = { strategy: strategy };
    
    if (strategy === 'recent') {
        params.keep_count = parseInt(document.getElementById('keepCount').value);
    } else if (strategy === 'date') {
        params.keep_days = parseInt(document.getElementById('keepDays').value);
    }
    
    try {
        const response = await fetch('/api/config/backups/cleanup', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            // 关闭模态框
            const cleanupModal = bootstrap.Modal.getInstance(document.getElementById('cleanupBackupModal'));
            cleanupModal.hide();
            // 刷新备份文件列表
            await loadBackupFiles();
        } else {
            showAlert('清理备份失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('清理备份失败:', error);
        showAlert('清理备份失败', 'danger');
    }
}

// ========== Webhook 配置管理 ==========

// 加载 Webhook 配置列表
async function loadWebhookConfigs() {
    try {
        const response = await fetch('/api/notification/webhooks', {
            credentials: 'include'
        });

        const data = await response.json();

        if (data.status === 'success') {
            renderWebhookConfigs(data.data);
        } else {
            console.error('加载 Webhook 配置失败:', data.message);
        }
    } catch (error) {
        console.error('加载 Webhook 配置失败:', error);
    }
}

// 渲染 Webhook 配置列表
function renderWebhookConfigs(webhooks) {
    const container = document.getElementById('webhook-configs-container');

    if (!webhooks || webhooks.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">暂无 Webhook 配置</p>
                <button type="button" class="btn btn-outline-primary" onclick="showAddWebhookModal()">
                    <i class="bi bi-plus-lg me-1"></i>添加第一个配置
                </button>
            </div>
        `;
        return;
    }

    let html = '<div class="row g-3">';
    webhooks.forEach(webhook => {
        const typesBadge = webhook.types === 'all'
            ? '<span class="badge bg-primary">全部类型</span>'
            : webhook.types.split(',').map(t => `<span class="badge bg-secondary">${t.trim()}</span>`).join(' ');

        html += `
            <div class="col-md-6">
                <div class="card border ${webhook.enabled ? 'border-primary' : 'border-secondary'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-send ${webhook.enabled ? 'text-success' : 'text-muted'} me-2"></i>
                                <h6 class="card-title mb-0">Webhook #${webhook.id}</h6>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="webhook-enabled-${webhook.id}"
                                       ${webhook.enabled ? 'checked' : ''} onchange="toggleWebhookEnabled(${webhook.id}, this.checked)">
                                <label class="form-check-label" for="webhook-enabled-${webhook.id}"></label>
                            </div>
                        </div>
                        <p class="card-text small text-muted mb-2">
                            <i class="bi bi-link-45deg me-1"></i>${webhook.url}
                        </p>
                        <div class="mb-2">
                            ${typesBadge}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showEditWebhookModal(${webhook.id})">
                                <i class="bi bi-pencil me-1"></i>编辑
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="testWebhook(${webhook.id})">
                                <i class="bi bi-play-circle me-1"></i>测试
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="showDeleteWebhookModal(${webhook.id})">
                                <i class="bi bi-trash me-1"></i>删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// 显示添加 Webhook 模态框
function showAddWebhookModal() {
    document.getElementById('webhook-modal-title').textContent = '添加 Webhook 配置';
    document.getElementById('webhook-id').value = '';
    document.getElementById('webhook-enabled-input').checked = true;
    document.getElementById('webhook-url-input').value = '';
    document.getElementById('webhook-method-input').value = 'POST';
    document.getElementById('webhook-headers-input').value = '';
    document.getElementById('webhook-template-input').value = '';
    document.getElementById('webhook-types-input').value = 'all';

    const modal = new bootstrap.Modal(document.getElementById('webhookModal'));
    modal.show();
}

// 显示编辑 Webhook 模态框
async function showEditWebhookModal(webhookId) {
    try {
        const response = await fetch('/api/notification/webhooks', {
            credentials: 'include'
        });

        const data = await response.json();

        if (data.status === 'success') {
            const webhook = data.data.find(w => w.id === webhookId);
            if (webhook) {
                document.getElementById('webhook-modal-title').textContent = '编辑 Webhook 配置';
                document.getElementById('webhook-id').value = webhook.id;
                document.getElementById('webhook-enabled-input').checked = webhook.enabled;
                document.getElementById('webhook-url-input').value = webhook.url;
                document.getElementById('webhook-method-input').value = webhook.method;
                document.getElementById('webhook-headers-input').value = webhook.headers;
                document.getElementById('webhook-template-input').value = webhook.template;
                document.getElementById('webhook-types-input').value = webhook.types;

                const modal = new bootstrap.Modal(document.getElementById('webhookModal'));
                modal.show();
            }
        }
    } catch (error) {
        console.error('加载 Webhook 配置失败:', error);
        showAlert('加载 Webhook 配置失败', 'danger');
    }
}

// 保存 Webhook 配置
async function saveWebhookConfig() {
    const webhookId = document.getElementById('webhook-id').value;
    const webhookData = {
        enabled: document.getElementById('webhook-enabled-input').checked,
        url: document.getElementById('webhook-url-input').value,
        method: document.getElementById('webhook-method-input').value,
        headers: document.getElementById('webhook-headers-input').value,
        template: document.getElementById('webhook-template-input').value,
        types: document.getElementById('webhook-types-input').value
    };

    // 验证必填字段
    if (!webhookData.url) {
        showAlert('Webhook URL 为必填项', 'warning');
        return;
    }

    try {
        let response;
        if (webhookId) {
            // 更新
            response = await fetch(`/api/notification/webhooks/${webhookId}`, {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData)
            });
        } else {
            // 创建
            response = await fetch('/api/notification/webhooks', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData)
            });
        }

        const data = await response.json();

        if (data.status === 'success') {
            showAlert(webhookId ? 'Webhook 配置更新成功' : 'Webhook 配置创建成功', 'success');
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('webhookModal'));
            modal.hide();
            // 刷新配置列表
            await loadWebhookConfigs();
        } else {
            showAlert('保存失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('保存 Webhook 配置失败:', error);
        showAlert('保存 Webhook 配置失败', 'danger');
    }
}

// 切换 Webhook 启用状态
async function toggleWebhookEnabled(webhookId, enabled) {
    try {
        const response = await fetch(`/api/notification/webhooks/${webhookId}`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: enabled })
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert(enabled ? 'Webhook 已启用' : 'Webhook 已禁用', 'success');
            await loadWebhookConfigs();
        } else {
            showAlert('操作失败: ' + data.message, 'danger');
            // 恢复开关状态
            const checkbox = document.getElementById(`webhook-enabled-${webhookId}`);
            checkbox.checked = !enabled;
        }
    } catch (error) {
        console.error('切换 Webhook 启用状态失败:', error);
        showAlert('操作失败', 'danger');
        // 恢复开关状态
        const checkbox = document.getElementById(`webhook-enabled-${webhookId}`);
        checkbox.checked = !enabled;
    }
}

// 显示删除 Webhook 确认模态框
function showDeleteWebhookModal(webhookId) {
    document.getElementById('delete-webhook-id').value = webhookId;
    const modal = new bootstrap.Modal(document.getElementById('deleteWebhookModal'));
    modal.show();
}

// 删除 Webhook 配置
async function deleteWebhookConfig() {
    const webhookId = document.getElementById('delete-webhook-id').value;

    try {
        const response = await fetch(`/api/notification/webhooks/${webhookId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert('Webhook 配置删除成功', 'success');
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteWebhookModal'));
            modal.hide();
            // 刷新配置列表
            await loadWebhookConfigs();
        } else {
            showAlert('删除失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('删除 Webhook 配置失败:', error);
        showAlert('删除 Webhook 配置失败', 'danger');
    }
}

// 测试 Webhook 配置
async function testWebhook(webhookId) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';

    try {
        const response = await fetch(`/api/notification/webhooks/${webhookId}/test`, {
            method: 'POST',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.status === 'success') {
            const webhookResult = data.data.webhook.webhooks[0];
            if (webhookResult.success) {
                showAlert('Webhook 测试成功', 'success');
            } else {
                showAlert('Webhook 测试失败: ' + webhookResult.message, 'warning');
            }
        } else {
            showAlert('测试失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('测试 Webhook 失败:', error);
        showAlert('测试 Webhook 失败', 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}
    </script>
    <!-- Webhook 配置模态框 -->
    <div class="modal fade"
         id="webhookModal"
         tabindex="-1"
         aria-labelledby="webhookModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="webhook-modal-title">添加 Webhook 配置</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="webhook-form">
                        <input type="hidden" id="webhook-id">
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-toggle-on me-1 text-success"></i>启用
                                </label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="webhook-enabled-input"
                                           checked>
                                    <label class="form-check-label" for="webhook-enabled-input">启用</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="webhook-url-input" class="form-label fw-semibold">
                                    <i class="bi bi-link me-1 text-info"></i>Webhook URL
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="url"
                                       class="form-control"
                                       id="webhook-url-input"
                                       required
                                       placeholder="https://your-webhook-url.com/hook">
                            </div>
                            <div class="col-md-4">
                                <label for="webhook-method-input" class="form-label fw-semibold">
                                    <i class="bi bi-arrow-right-circle me-1"></i>请求方法
                                </label>
                                <select class="form-select" id="webhook-method-input">
                                    <option value="POST">POST</option>
                                    <option value="GET">GET</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="webhook-types-input" class="form-label fw-semibold">
                                <i class="bi bi-tags me-1"></i>通知类型
                                <i class="bi bi-question-circle ms-1 text-muted"
                                   data-bs-toggle="tooltip"
                                   title="选择要触发的通知类型，多个类型用逗号分隔。选择 'all' 表示所有类型"></i>
                            </label>
                            <select class="form-select" id="webhook-types-input">
                                <option value="all">全部类型 (all)</option>
                                <option value="request_received">收到请求 (request_received)</option>
                                <option value="bangumi_id_found">找到番剧 (bangumi_id_found)</option>
                                <option value="mark_success">标记成功 (mark_success)</option>
                                <option value="mark_failed">标记失败 (mark_failed)</option>
                                <option value="mark_skipped">标记跳过 (mark_skipped)</option>
                                <option value="config_error">配置错误 (config_error)</option>
                                <option value="anime_not_found">未找到番剧 (anime_not_found)</option>
                                <option value="episode_not_found">未找到剧集 (episode_not_found)</option>
                                <option value="api_auth_error">API认证失败 (api_auth_error)</option>
                                <option value="api_error">API错误 (api_error)</option>
                                <option value="api_retry_failed">API重试失败 (api_retry_failed)</option>
                                <option value="ip_locked">IP被锁定 (ip_locked)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="webhook-headers-input" class="form-label fw-semibold">
                                <i class="bi bi-list-ul me-1"></i>自定义请求头（可选）
                            </label>
                            <textarea class="form-control"
                                      id="webhook-headers-input"
                                      rows="2"
                                      placeholder='{"Authorization": "Bearer token"}'></textarea>
                            <div class="form-text">支持 JSON 格式，例如：{"Authorization": "Bearer token"}</div>
                        </div>
                        <div class="mb-3">
                            <label for="webhook-template-input" class="form-label fw-semibold">
                                <i class="bi bi-code-square me-1"></i>消息模板（可选）
                            </label>
                            <textarea class="form-control"
                                      id="webhook-template-input"
                                      rows="5"
                                      placeholder='{"content": "📢 {title} S{season}E{episode} - {notification_type}"}'></textarea>
                            <div class="form-text">
                                支持 JSON 格式，可用变量：{timestamp}, {user_name}, {title}, {season}, {episode}, {source}, {notification_type}, {error_message}, {subject_id}, {episode_id}
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveWebhookConfig()">
                        <i class="bi bi-save me-1"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 删除 Webhook 确认模态框 -->
    <div class="modal fade"
         id="deleteWebhookModal"
         tabindex="-1"
         aria-labelledby="deleteWebhookModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteWebhookModalLabel">确认删除</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除这个 Webhook 配置吗？此操作不可逆。</p>
                    <input type="hidden" id="delete-webhook-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="deleteWebhookConfig()">
                        <i class="bi bi-trash me-1"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 邮件配置模态框 -->
    <div class="modal fade"
         id="emailModal"
         tabindex="-1"
         aria-labelledby="emailModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">
                        <i class="bi bi-envelope me-2"></i><span id="email-modal-title">添加邮件配置</span>
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="email-config-form">
                        <input type="hidden" id="email-id">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="email-enabled-input"
                                       checked>
                                <label class="form-check-label fw-semibold" for="email-enabled-input">
                                    <i class="bi bi-toggle-on me-1"></i>启用此配置
                                </label>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <label for="email-smtp-server-input" class="form-label fw-semibold">
                                    <i class="bi bi-server me-1"></i>SMTP 服务器 <span class="text-danger">*</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="email-smtp-server-input"
                                       required
                                       placeholder="smtp.qq.com">
                            </div>
                            <div class="col-md-4">
                                <label for="email-smtp-port-input" class="form-label fw-semibold">
                                    <i class="bi bi-hdd-network me-1"></i>端口 <span class="text-danger">*</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="email-smtp-port-input"
                                       required
                                       placeholder="465"
                                       min="1"
                                       max="65535"
                                       value="465">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="email-smtp-username-input" class="form-label fw-semibold">
                                    <i class="bi bi-person me-1"></i>SMTP 用户名 <span class="text-danger">*</span>
                                </label>
                                <input type="email"
                                       class="form-control"
                                       id="email-smtp-username-input"
                                       required
                                       placeholder="your-email@qq.com">
                            </div>
                            <div class="col-md-6">
                                <label for="email-smtp-password-input" class="form-label fw-semibold">
                                    <i class="bi bi-key me-1"></i>SMTP 密码/授权码 <span class="text-danger" id="email-password-required">*</span>
                                </label>
                                <input type="password"
                                       class="form-control"
                                       id="email-smtp-password-input"
                                       placeholder="授权码或密码">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="email-from-input" class="form-label fw-semibold">
                                    <i class="bi bi-envelope-at me-1"></i>发件人地址（可选）
                                </label>
                                <input type="email"
                                       class="form-control"
                                       id="email-from-input"
                                       placeholder="留空使用 SMTP 用户名">
                            </div>
                            <div class="col-md-6">
                                <label for="email-to-input" class="form-label fw-semibold">
                                    <i class="bi bi-envelope-check me-1"></i>收件人地址 <span class="text-danger">*</span>
                                </label>
                                <input type="email"
                                       class="form-control"
                                       id="email-to-input"
                                       required
                                       placeholder="recipient@example.com">
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="email-smtp-use-tls-input"
                                       checked>
                                <label class="form-check-label fw-semibold" for="email-smtp-use-tls-input">
                                    <i class="bi bi-shield-lock me-1"></i>使用 TLS 加密
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email-subject-input" class="form-label fw-semibold">
                                <i class="bi bi-chat-square-text me-1"></i>邮件标题模板（可选）
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="email-subject-input"
                                   placeholder="[Bangumi-Syncer] {error_type} - {title} S{season}E{episode}">
                            <div class="form-text">
                                可用变量：{timestamp}, {user_name}, {title}, {season}, {episode}, {source}, {error_type}, {error_message}, {notification_type}, {subject_id}, {episode_id}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email-template-file-input" class="form-label fw-semibold">
                                <i class="bi bi-file-earmark-code me-1"></i>自定义模板文件路径（可选）
                            </label>
                            <input type="text"
                                   class="form-control font-monospace"
                                   id="email-template-file-input"
                                   placeholder="留空使用默认模板">
                            <div class="form-text">支持相对路径和绝对路径</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-tags me-1"></i>通知类型
                            </label>
                            <div class="border rounded p-3"
                                 style="max-height: 200px;
                                        overflow-y: auto">
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-request_received"
                                           value="request_received">
                                    <label class="form-check-label" for="email-type-request_received">收到同步请求 (request_received)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-bangumi_id_found"
                                           value="bangumi_id_found">
                                    <label class="form-check-label" for="email-type-bangumi_id_found">匹配到番剧 (bangumi_id_found)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-mark_success"
                                           value="mark_success">
                                    <label class="form-check-label" for="email-type-mark_success">同步成功 (mark_success)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-mark_failed"
                                           value="mark_failed">
                                    <label class="form-check-label" for="email-type-mark_failed">同步失败 (mark_failed)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-mark_skipped"
                                           value="mark_skipped">
                                    <label class="form-check-label" for="email-type-mark_skipped">已看过跳过 (mark_skipped)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-config_error"
                                           value="config_error">
                                    <label class="form-check-label" for="email-type-config_error">配置错误 (config_error)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-anime_not_found"
                                           value="anime_not_found">
                                    <label class="form-check-label" for="email-type-anime_not_found">未找到番剧 (anime_not_found)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-episode_not_found"
                                           value="episode_not_found">
                                    <label class="form-check-label" for="email-type-episode_not_found">未找到剧集 (episode_not_found)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-api_auth_error"
                                           value="api_auth_error">
                                    <label class="form-check-label" for="email-type-api_auth_error">API认证失败 (api_auth_error)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-api_error"
                                           value="api_error">
                                    <label class="form-check-label" for="email-type-api_error">API错误 (api_error)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-api_retry_failed"
                                           value="api_retry_failed">
                                    <label class="form-check-label" for="email-type-api_retry_failed">API重试失败 (api_retry_failed)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="email-type-ip_locked"
                                           value="ip_locked">
                                    <label class="form-check-label" for="email-type-ip_locked">IP被锁定 (ip_locked)</label>
                                </div>
                            </div>
                            <div class="form-text">勾选需要的通知类型，不勾选则接收所有类型</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveEmailConfig()">
                        <i class="bi bi-save me-1"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 删除邮件确认模态框 -->
    <div class="modal fade"
         id="deleteEmailModal"
         tabindex="-1"
         aria-labelledby="deleteEmailModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteEmailModalLabel">确认删除</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除这个邮件配置吗？此操作不可逆。</p>
                    <input type="hidden" id="delete-email-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="deleteEmailConfig()">
                        <i class="bi bi-trash me-1"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
// ========== 邮件配置管理 ==========

// 加载邮件配置列表
async function loadEmailConfigs() {
    try {
        const response = await fetch('/api/notification/emails', {
            credentials: 'include'
        });

        const data = await response.json();

        if (data.status === 'success') {
            renderEmailConfigs(data.data);
        } else {
            console.error('加载邮件配置失败:', data.message);
        }
    } catch (error) {
        console.error('加载邮件配置失败:', error);
    }
}

// 渲染邮件配置列表
function renderEmailConfigs(emails) {
    const container = document.getElementById('email-configs-container');

    if (!emails || emails.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">暂无邮件配置</p>
                <button type="button" class="btn btn-outline-success" onclick="showAddEmailModal()">
                    <i class="bi bi-plus-lg me-1"></i>添加第一个配置
                </button>
            </div>
        `;
        return;
    }

    let html = '<div class="row g-3">';
    emails.forEach(email => {
        const typesBadge = email.types === 'all'
            ? '<span class="badge bg-success">全部类型</span>'
            : email.types.split(',').map(t => `<span class="badge bg-secondary">${t.trim()}</span>`).join(' ');

        html += `
            <div class="col-md-6">
                <div class="card border ${email.enabled ? 'border-success' : 'border-secondary'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope ${email.enabled ? 'text-success' : 'text-muted'} me-2"></i>
                                <h6 class="card-title mb-0">邮件配置 #${email.id}</h6>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="email-enabled-${email.id}"
                                       ${email.enabled ? 'checked' : ''} onchange="toggleEmailEnabled(${email.id}, this.checked)">
                                <label class="form-check-label" for="email-enabled-${email.id}"></label>
                            </div>
                        </div>
                        <p class="card-text small text-muted mb-2">
                            <i class="bi bi-envelope-check me-1"></i>${email.email_to}
                        </p>
                        <p class="card-text small text-muted mb-2">
                            <i class="bi bi-server me-1"></i>${email.smtp_server}:${email.smtp_port}
                        </p>
                        <div class="mb-2">
                            ${typesBadge}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="showEditEmailModal(${email.id})">
                                <i class="bi bi-pencil me-1"></i>编辑
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="testEmail(${email.id})">
                                <i class="bi bi-play-circle me-1"></i>测试
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="showDeleteEmailModal(${email.id})">
                                <i class="bi bi-trash me-1"></i>删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// 显示添加邮件配置模态框
function showAddEmailModal() {
    document.getElementById('email-modal-title').textContent = '添加邮件配置';
    document.getElementById('email-id').value = '';
    document.getElementById('email-enabled-input').checked = true;
    document.getElementById('email-smtp-server-input').value = '';
    document.getElementById('email-smtp-port-input').value = '465';
    document.getElementById('email-smtp-username-input').value = '';
    document.getElementById('email-smtp-password-input').value = '';
    document.getElementById('email-smtp-password-input').placeholder = '授权码或密码';
    document.getElementById('email-from-input').value = '';
    document.getElementById('email-to-input').value = '';
    document.getElementById('email-smtp-use-tls-input').checked = true;
    document.getElementById('email-subject-input').value = '';
    document.getElementById('email-template-file-input').value = '';
    
    // 新建时密码为必填
    document.getElementById('email-password-required').style.display = 'inline';

    // 重置复选框
    const checkboxes = document.querySelectorAll('[id^="email-type-"]');
    checkboxes.forEach(cb => cb.checked = false);

    const modal = new bootstrap.Modal(document.getElementById('emailModal'));
    modal.show();
}

// 显示编辑邮件配置模态框
async function showEditEmailModal(emailId) {
    try {
        const response = await fetch('/api/notification/emails', {
            credentials: 'include'
        });

        const data = await response.json();

        if (data.status === 'success') {
            const email = data.data.find(e => e.id == emailId);
            if (email) {
                document.getElementById('email-modal-title').textContent = '编辑邮件配置';
                document.getElementById('email-id').value = email.id;
                document.getElementById('email-enabled-input').checked = email.enabled;
                document.getElementById('email-smtp-server-input').value = email.smtp_server;
                document.getElementById('email-smtp-port-input').value = email.smtp_port;
                document.getElementById('email-smtp-username-input').value = email.smtp_username;
                // 保留密码掩码，用户可以选择修改或保持不变
                document.getElementById('email-smtp-password-input').value = email.smtp_password || '';
                // 编辑时提示用户可以不修改密码
                document.getElementById('email-smtp-password-input').placeholder = '留空则保持原密码不变';
                // 编辑时密码不是必填
                document.getElementById('email-password-required').style.display = 'none';
                document.getElementById('email-from-input').value = email.email_from;
                document.getElementById('email-to-input').value = email.email_to;
                document.getElementById('email-smtp-use-tls-input').checked = email.smtp_use_tls;
                document.getElementById('email-subject-input').value = email.email_subject;
                document.getElementById('email-template-file-input').value = email.email_template_file;

                // 设置复选框
                const checkboxes = document.querySelectorAll('[id^="email-type-"]');
                checkboxes.forEach(cb => {
                    if (email.types === 'all') {
                        cb.checked = false;
                    } else {
                        cb.checked = email.types.split(',').includes(cb.value);
                    }
                });

                const modal = new bootstrap.Modal(document.getElementById('emailModal'));
                modal.show();
            }
        }
    } catch (error) {
        console.error('加载邮件配置失败:', error);
        showAlert('加载邮件配置失败', 'danger');
    }
}

// 保存邮件配置
async function saveEmailConfig() {
    const emailId = document.getElementById('email-id').value;
    const passwordValue = document.getElementById('email-smtp-password-input').value;
    
    const emailData = {
        enabled: document.getElementById('email-enabled-input').checked,
        smtp_server: document.getElementById('email-smtp-server-input').value,
        smtp_port: parseInt(document.getElementById('email-smtp-port-input').value),
        smtp_username: document.getElementById('email-smtp-username-input').value,
        email_from: document.getElementById('email-from-input').value,
        email_to: document.getElementById('email-to-input').value,
        smtp_use_tls: document.getElementById('email-smtp-use-tls-input').checked,
        email_subject: document.getElementById('email-subject-input').value,
        email_template_file: document.getElementById('email-template-file-input').value,
        types: Array.from(document.querySelectorAll('[id^="email-type-"]:checked')).map(cb => cb.value).join(',') || 'all'
    };
    
    // 只有当密码不是掩码且不为空时才添加到请求数据中
    if (passwordValue && passwordValue !== '******') {
        emailData.smtp_password = passwordValue;
    }

    // 验证必填字段
    if (!emailData.smtp_server || !emailData.smtp_username || !emailData.email_to) {
        showAlert('请填写所有必填字段', 'warning');
        return;
    }
    
    // 新建时必须填写密码
    if (!emailId && !emailData.smtp_password) {
        showAlert('请填写 SMTP 密码/授权码', 'warning');
        return;
    }

    try {
        let response;
        if (emailId) {
            response = await fetch(`/api/notification/emails/${emailId}`, {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(emailData)
            });
        } else {
            response = await fetch('/api/notification/emails', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(emailData)
            });
        }

        const data = await response.json();
        if (data.status === 'success') {
            showAlert(emailId ? '邮件配置更新成功' : '邮件配置创建成功', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
            modal.hide();
            await loadEmailConfigs();
        } else {
            showAlert('保存失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('保存邮件配置失败:', error);
        showAlert('保存邮件配置失败', 'danger');
    }
}

// 切换邮件配置启用状态
async function toggleEmailEnabled(emailId, enabled) {
    try {
        const response = await fetch(`/api/notification/emails/${emailId}`, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        });

        const data = await response.json();
        if (data.status === 'success') {
            showAlert(enabled ? '邮件配置已启用' : '邮件配置已禁用', 'success');
            await loadEmailConfigs();
        } else {
            showAlert('操作失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('切换邮件配置状态失败:', error);
        showAlert('操作失败', 'danger');
    }
}

// 显示删除邮件配置确认模态框
function showDeleteEmailModal(emailId) {
    document.getElementById('delete-email-id').value = emailId;
    const modal = new bootstrap.Modal(document.getElementById('deleteEmailModal'));
    modal.show();
}

// 删除邮件配置
async function deleteEmailConfig() {
    const emailId = document.getElementById('delete-email-id').value;

    try {
        const response = await fetch(`/api/notification/emails/${emailId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();
        if (data.status === 'success') {
            showAlert('邮件配置删除成功', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteEmailModal'));
            modal.hide();
            await loadEmailConfigs();
        } else {
            showAlert('删除失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('删除邮件配置失败:', error);
        showAlert('删除邮件配置失败', 'danger');
    }
}

// 测试邮件配置
async function testEmail(emailId) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';

    try {
        const response = await fetch(`/api/notification/emails/${emailId}/test`, {
            method: 'POST',
            credentials: 'include'
        });

        const data = await response.json();
        if (data.status === 'success') {
            const emailResult = data.data.email.emails[0];
            if (emailResult.success) {
                showAlert('邮件测试成功', 'success');
            } else {
                showAlert('邮件测试失败: ' + emailResult.message, 'warning');
            }
        } else {
            showAlert('测试失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('测试邮件失败:', error);
        showAlert('测试邮件失败', 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}
    </script>
{% endblock %}
