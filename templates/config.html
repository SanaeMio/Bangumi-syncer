{% extends "base.html" %}

{% block title %}配置管理 - Bangumi Syncer{% endblock %}
{% block page_title %}配置管理{% endblock %}

{% block head %}

{% endblock %}

{% block page_actions %}
{% endblock %}

{% block content %}
<form id="config-form">
    <!-- 同步配置 -->
    <div class="row">
        <div class="col-12">
                    <div class="card shadow-sm mb-4 config-card">
            <div class="card-header py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-arrow-repeat me-2 text-success"></i>
                    <h6 class="m-0 fw-semibold">同步配置</h6>
                </div>
            </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                                                    <label for="sync-mode" class="form-label fw-semibold">
                            <i class="bi bi-gear me-1 text-success"></i>同步模式
                            <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                               title="单用户模式：只同步一个用户\n多用户模式：同步多个用户"></i>
                        </label>
                            <select class="form-select form-select-lg" id="sync-mode" name="sync.mode" onchange="toggleSyncMode()">
                                <option value="single">单用户模式</option>
                                <option value="multi">多用户模式</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="single-username-container">
                                                    <label for="single-username" class="form-label fw-semibold">
                            <i class="bi bi-person-check me-1 text-success"></i>单用户模式用户名
                            <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                               title="单用户模式用户名（Plex/Emby/Jellyfin中的用户名），用于跳过无需同步的用户提交的记录，只同步配置中的用户名产生的记录"></i>
                        </label>
                            <input type="text" class="form-control form-control-lg" id="single-username" name="sync.single_username" 
                                   placeholder="输入媒体服务器用户名">
                        </div>
                        <div class="col-12">
                                                    <label for="blocked-keywords" class="form-label fw-semibold">
                            <i class="bi bi-shield-x me-1 text-danger"></i>屏蔽关键词
                            <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                               title="屏蔽关键词列表，用逗号分隔。当番剧标题包含这些关键词时，将跳过同步处理。支持中文、英文、日文等多种语言的关键词"></i>
                        </label>
                            <input type="text" class="form-control form-control-lg" id="blocked-keywords" name="sync.blocked_keywords" 
                                   placeholder="多个关键词用逗号分隔，如：物语系列,特典">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bangumi账号配置（单用户模式） -->
    <div class="row" id="single-user-bangumi-section">
        <div class="col-12">
                    <div class="card shadow-sm mb-4 config-card">
            <div class="card-header py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle me-2 text-primary"></i>
                    <h6 class="m-0 fw-semibold">Bangumi账号配置</h6>
                </div>
            </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                                                    <label for="bangumi-username" class="form-label fw-semibold">
                            <i class="bi bi-person me-1 text-primary"></i>用户名
                            <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                               title="Bangumi 的用户名或 UID。如果设置了用户名，只能填用户名。UID 就是个人资料页里 @123456 或者网址 bgm.tv/user/123456 的数字部分"></i>
                        </label>
                            <input type="text" class="form-control form-control-lg" id="bangumi-username" name="bangumi.username" 
                                   placeholder="输入Bangumi用户名或UID">
                        </div>
                                                <div class="col-md-6">
                            <label for="bangumi-access-token" class="form-label fw-semibold">
                                <i class="bi bi-key me-1 text-primary"></i>访问令牌
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="令牌，注意有效期。生成网址：https://next.bgm.tv/demo/access-token"></i>
                                <a href="https://next.bgm.tv/demo/access-token" target="_blank" class="btn btn-link btn-sm p-0 ms-2 text-decoration-none">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </label>
                            <div class="position-relative">
                                <input type="password" class="form-control form-control-lg pe-5" id="bangumi-access-token" name="bangumi.access_token" 
                                       placeholder="输入Bangumi访问令牌">
                                <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 password-toggle-btn" 
                                        type="button" id="toggle-token-visibility">
                                    <i class="bi bi-eye text-muted" id="token-visibility-icon"></i>
                                </button>
                            </div>
                        </div>
                                                <div class="col-12">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-eye-slash me-1 text-warning"></i>观看记录仅自己可见
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="观看记录是否仅自己可见。启用后观看记录只有自己能看到，不启用则为公开"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="bangumi-private" name="bangumi.private">
                                <label class="form-check-label" for="bangumi-private">启用</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 多用户配置 -->
    <div class="row" id="multi-user-section" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-people me-2 text-secondary"></i>
                        <h6 class="m-0 fw-semibold">多用户配置</h6>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addBangumiAccount()">
                        <i class="bi bi-plus-circle me-1"></i>添加Bangumi账号
                    </button>
                </div>
                <div class="card-body">
                    <div id="bangumi-accounts-container">
                        <!-- 动态添加的Bangumi账号配置 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 高级配置 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-sliders me-2 text-info"></i>
                        <h6 class="m-0 fw-semibold">高级配置</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="script-proxy" class="form-label fw-semibold">
                                <i class="bi bi-globe me-1 text-info"></i>HTTP代理
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="脚本的 HTTP 代理，例如 http://127.0.0.1:7890。若用 OpenClash 可能慢，原因未知，可尝试 CFW 或透明代理等"></i>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" id="script-proxy" name="dev.script_proxy" 
                                       placeholder="如：http://127.0.0.1:7890">
                                <button class="btn btn-warning fw-bold" type="button" onclick="showProxyHelper()" 
                                        title="智能代理配置助手 - 自动检测环境并推荐最佳配置"
                                        style="min-width: 120px;">
                                    <i class="bi bi-magic me-1"></i>智能配置
                                </button>
                            </div>
                            <div class="form-text mt-1">
                                <i class="bi bi-lightbulb text-warning me-1"></i>
                                <small class="text-muted">点击"智能配置"按钮获取适合您环境的代理配置建议</small>
                            </div>
                            
                            <!-- 代理助手区域 -->
                            <div id="proxy-helper" class="mt-3" style="display: none;">
                                <div class="card border-info">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="bi bi-magic me-2 text-warning"></i>智能代理配置助手
                                            <small class="text-muted ms-2">支持Docker和本机环境</small>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- 端口号配置 -->
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6">
                                                <label for="proxy-port" class="form-label fw-semibold">
                                                    <i class="bi bi-hdd-network me-1"></i>代理端口号
                                                </label>
                                                <input type="number" class="form-control" id="proxy-port" 
                                                       value="7890" min="1" max="65535" 
                                                       onchange="updateProxySuggestions()"
                                                       placeholder="如：7890">
                                            </div>
                                            <div class="col-md-6 d-flex align-items-end">
                                                <button type="button" class="btn btn-outline-primary" onclick="detectPortFromInput(event)">
                                                    <i class="bi bi-search me-1"></i>从HTTP代理输入框识别
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="proxy-suggestions" class="mb-3">
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm text-info" role="status">
                                                    <span class="visually-hidden">检测中...</span>
                                                </div>
                                                <span class="ms-2">正在检测环境并生成建议...</span>
                                            </div>
                                        </div>
                                        <!-- 主机连通性测试区域 -->
                                        <div class="mt-3 border-top pt-3">
                                            <h6 class="text-primary mb-3">
                                                <i class="bi bi-wifi me-2"></i>网络连通性测试
                                                <small class="text-muted ms-2">验证容器是否能访问宿主机</small>
                                            </h6>
                                            
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label for="test-host" class="form-label">主机地址</label>
                                                    <input type="text" class="form-control form-control-sm" id="test-host" 
                                                           placeholder="如：192.168.1.100" value="192.168.1.100">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="test-port" class="form-label">端口</label>
                                                    <input type="number" class="form-control form-control-sm" id="test-port" 
                                                           value="7890" min="1" max="65535">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="test-timeout" class="form-label">超时(秒)</label>
                                                    <input type="number" class="form-control form-control-sm" id="test-timeout" 
                                                           value="5" min="1" max="30">
                                                </div>
                                                <div class="col-md-2 d-flex align-items-end">
                                                    <button type="button" class="btn btn-primary btn-sm w-100" 
                                                            onclick="testHostConnectivity()" id="test-host-btn">
                                                        <i class="bi bi-play-circle me-1"></i>测试
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div id="host-test-result" class="mb-3" style="display: none;">
                                                <!-- 测试结果将显示在这里 -->
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                点击建议的代理地址可自动填入，可自定义端口号重新生成建议
                                            </small>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideProxyHelper()">
                                                关闭
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-shield-check me-1 text-success"></i>SSL证书验证
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="SSL证书验证。当使用代理时可能需要关闭。注意：关闭SSL验证会降低安全性，仅在代理环境下出现SSL错误时使用"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="ssl-verify" name="dev.ssl_verify">
                                <label class="form-check-label" for="ssl-verify">启用SSL验证</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-bug me-1 text-warning"></i>调试模式
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="是否开启debug模式，一般不用开。开启后会输出详细的调试信息"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="debug-mode" name="dev.debug">
                                <label class="form-check-label" for="debug-mode">启用调试模式</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Web认证配置 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-shield-lock me-2 text-danger"></i>
                        <h6 class="m-0 fw-semibold">Web认证配置</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-shield-check me-1 text-success"></i>启用Web认证
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="是否启用Web管理界面认证，建议在外网环境下启用。禁用后任何人都可以访问管理界面"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="auth-enabled" name="auth.enabled">
                                <label class="form-check-label" for="auth-enabled">启用</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="auth-username" class="form-label fw-semibold">
                                <i class="bi bi-person me-1 text-primary"></i>管理员用户名
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="Web管理界面的登录用户名"></i>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="auth-username" name="auth.username" 
                                   placeholder="admin">
                        </div>
                        <div class="col-md-3">
                            <label for="auth-password" class="form-label fw-semibold">
                                <i class="bi bi-key me-1 text-warning"></i>管理员密码
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="Web管理界面的登录密码。留空表示不修改当前密码"></i>
                            </label>
                            <div class="position-relative">
                                <input type="password" class="form-control form-control-lg pe-5" id="auth-password" name="auth.password" 
                                       placeholder="留空表示不修改密码">
                                <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 password-toggle-btn" 
                                        type="button" id="toggle-auth-password-visibility">
                                    <i class="bi bi-eye text-muted" id="auth-password-visibility-icon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="session-timeout" class="form-label fw-semibold">
                                <i class="bi bi-clock me-1 text-info"></i>会话超时时间
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="登录会话的超时时间（秒），默认3600秒（1小时）"></i>
                            </label>
                            <input type="number" class="form-control form-control-lg" id="session-timeout" name="auth.session_timeout" 
                                   placeholder="3600" min="300" max="86400">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-shield-lock me-1 text-success"></i>启用HTTPS安全Cookie
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="启用后Cookie只在HTTPS连接下传输，提高安全性。仅在使用HTTPS时启用"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="https-only" name="auth.https_only">
                                <label class="form-check-label" for="https-only">启用</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="max-login-attempts" class="form-label fw-semibold">
                                <i class="bi bi-shield-x me-1 text-warning"></i>最大登录尝试次数
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="单个IP地址的最大登录失败次数，超过后将被锁定"></i>
                            </label>
                            <input type="number" class="form-control form-control-lg" id="max-login-attempts" name="auth.max_login_attempts" 
                                   placeholder="5" min="1" max="20">
                        </div>
                        <div class="col-md-3">
                            <label for="lockout-duration" class="form-label fw-semibold">
                                <i class="bi bi-clock-history me-1 text-danger"></i>锁定时间（秒）
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="IP被锁定的时间长度（秒），默认900秒（15分钟）"></i>
                            </label>
                            <input type="number" class="form-control form-control-lg" id="lockout-duration" name="auth.lockout_duration" 
                                   placeholder="900" min="60" max="86400">
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>安全提醒：</strong>在外网环境下强烈建议启用认证功能。修改密码后需要重新登录。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bangumi-data配置 -->
    <div class="row">
        <div class="col-12">
                    <div class="card shadow-sm mb-4 config-card">
            <div class="card-header py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-hdd-stack me-2 text-primary"></i>
                    <h6 class="m-0 fw-semibold">Bangumi-data配置</h6>
                </div>
            </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-search me-1 text-success"></i>使用Bangumi-data匹配
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="是否启用 bangumi-data 匹配。启用后会先尝试通过 bangumi-data 匹配番剧ID，匹配成功后可以减少API请求次数"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="bangumi-data-enabled" name="bangumi_data.enabled">
                                <label class="form-check-label" for="bangumi-data-enabled">启用</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-hdd me-1 text-primary"></i>使用本地缓存
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="是否使用本地缓存文件，默认启用。启用后会将下载的数据保存到本地，之后再次启动时优先使用缓存"></i>
                            </label>
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="bangumi-data-cache" name="bangumi_data.use_cache">
                                <label class="form-check-label" for="bangumi-data-cache">启用</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="cache-ttl" class="form-label fw-semibold">
                                <i class="bi bi-clock me-1 text-warning"></i>缓存有效期（天）
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="缓存有效期（天），超过此时间后会自动更新缓存。设置为0表示每次启动都会更新缓存"></i>
                            </label>
                            <input type="number" class="form-control form-control-lg" id="cache-ttl" name="bangumi_data.cache_ttl_days" 
                                   placeholder="7" min="0" max="365">
                        </div>
                    </div>
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <label for="data-url" class="form-label fw-semibold">
                                <i class="bi bi-link me-1 text-info"></i>数据源URL
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="bangumi-data数据源的URL地址，默认使用官方CDN地址。如果官方地址无法访问，可以替换为其他镜像地址"></i>
                            </label>
                            <input type="url" class="form-control form-control-lg" id="data-url" name="bangumi_data.data_url" 
                                   placeholder="https://unpkg.com/bangumi-data@0.3/dist/data.json">
                        </div>
                        <div class="col-md-6">
                            <label for="local-cache-path" class="form-label fw-semibold">
                                <i class="bi bi-folder me-1 text-secondary"></i>本地缓存路径
                                <i class="bi bi-question-circle ms-1 text-muted" data-bs-toggle="tooltip" 
                                   title="bangumi-data本地缓存文件的存储路径，默认为当前目录下的bangumi_data_cache.json文件"></i>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="local-cache-path" name="bangumi_data.local_cache_path" 
                                   placeholder="./bangumi_data_cache.json">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- 操作按钮 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-gear me-2 text-primary"></i>
                    <h6 class="m-0 fw-semibold">配置操作</h6>
                </div>
            </div>
            <div class="card-body text-center py-4">
                <div class="btn-group me-3" role="group">
                    <button type="button" class="btn btn-primary px-4" onclick="saveConfig()">
                        <i class="bi bi-save me-2"></i>保存配置
                    </button>
                    <button type="button" class="btn btn-outline-secondary px-4" onclick="loadConfig(true)">
                        <i class="bi bi-arrow-clockwise me-2"></i>重新加载
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-info px-4" onclick="backupConfig()">
                        <i class="bi bi-download me-2"></i>备份配置
                    </button>
                    <button type="button" class="btn btn-outline-warning px-4" onclick="showRestoreModal()">
                        <i class="bi bi-upload me-2"></i>恢复配置
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 测试同步 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle me-2 text-warning"></i>
                    <h6 class="m-0 fw-semibold">测试同步</h6>
                </div>
            </div>
            <div class="card-body">
                <form id="test-sync-form">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="test-title" class="form-label fw-semibold">
                                <i class="bi bi-film me-1 text-warning"></i>番剧标题
                            </label>
                            <input type="text" class="form-control form-control-lg" id="test-title" placeholder="测试番剧" required>
                        </div>
                        <div class="col-md-3">
                            <label for="test-season" class="form-label fw-semibold">
                                <i class="bi bi-calendar3 me-1 text-warning"></i>季度
                            </label>
                            <input type="number" class="form-control form-control-lg" id="test-season" value="1" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="test-episode" class="form-label fw-semibold">
                                <i class="bi bi-collection-play me-1 text-warning"></i>集数
                            </label>
                            <input type="number" class="form-control form-control-lg" id="test-episode" value="1" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="test-user" class="form-label fw-semibold">
                                <i class="bi bi-person me-1 text-warning"></i>用户名
                            </label>
                            <input type="text" class="form-control form-control-lg" id="test-user" placeholder="测试用户" required>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="button" class="btn btn-warning px-3" id="test-sync-btn" onclick="testSync()">
                                <i class="bi bi-play-circle me-2"></i>测试同步
                            </button>
                            <div class="mt-3" id="test-sync-progress" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span id="test-sync-status">正在测试同步...</span>
                                </div>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="mt-3" id="test-sync-result" style="display: none;">
                                <div class="alert alert-dismissible fade show" role="alert" id="test-result-alert">
                                    <div id="test-result-content"></div>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 恢复配置模态框 -->
<div class="modal fade" id="restoreConfigModal" tabindex="-1" aria-labelledby="restoreConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreConfigModalLabel">
                    <i class="bi bi-upload me-2"></i>恢复配置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-semibold mb-0">
                                <i class="bi bi-clock-history me-1"></i>选择备份文件
                            </h6>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="showCleanupModal()">
                                <i class="bi bi-trash me-1"></i>清理备份
                            </button>
                        </div>
                        <div class="list-group" id="backup-files-list">
                            <div class="text-center p-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">正在加载备份文件...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-semibold mb-3">
                            <i class="bi bi-eye me-1"></i>配置预览
                        </h6>
                        <div id="config-preview" class="border rounded p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                            <p class="text-muted mb-0">选择左侧的备份文件以预览配置内容</p>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>注意：</strong>恢复配置将覆盖当前所有配置，请确保已备份当前配置。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" id="restore-confirm-btn" onclick="confirmRestore()" disabled>
                    <i class="bi bi-check-circle me-1"></i>确认恢复
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 清理备份模态框 -->
<div class="modal fade" id="cleanupBackupModal" tabindex="-1" aria-labelledby="cleanupBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cleanupBackupModalLabel">
                    <i class="bi bi-trash me-2"></i>清理备份文件
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>清理策略：</strong>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cleanupStrategy" id="keepRecent" value="recent" checked>
                            <label class="form-check-label" for="keepRecent">
                                <strong>保留最近的备份</strong><br>
                                <small class="text-muted">保留最近的几个备份文件</small>
                            </label>
                        </div>
                        <div class="mt-2 ms-4">
                            <label for="keepCount" class="form-label">保留数量：</label>
                            <select class="form-select form-select-sm" id="keepCount">
                                <option value="3">3个</option>
                                <option value="5" selected>5个</option>
                                <option value="10">10个</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cleanupStrategy" id="keepByDate" value="date">
                            <label class="form-check-label" for="keepByDate">
                                <strong>按日期清理</strong><br>
                                <small class="text-muted">删除指定天数前的备份</small>
                            </label>
                        </div>
                        <div class="mt-2 ms-4">
                            <label for="keepDays" class="form-label">保留天数：</label>
                            <select class="form-select form-select-sm" id="keepDays">
                                <option value="7">7天</option>
                                <option value="30" selected>30天</option>
                                <option value="90">90天</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="cleanupStrategy" id="deleteAll" value="all">
                        <label class="form-check-label" for="deleteAll">
                            <strong class="text-danger">删除所有备份</strong><br>
                            <small class="text-muted">删除所有备份文件（慎用）</small>
                        </label>
                    </div>
                </div>
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>注意：</strong>此操作不可逆，请确保已经确认要删除的备份文件。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmCleanup()">
                    <i class="bi bi-trash me-1"></i>确认清理
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

// 全局变量
let bangumiAccountCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 初始化令牌显示/隐藏功能
    document.getElementById('toggle-token-visibility').addEventListener('click', function() {
        const tokenInput = document.getElementById('bangumi-access-token');
        const icon = document.getElementById('token-visibility-icon');
        
        if (tokenInput.type === 'password') {
            tokenInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            tokenInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });
    
    // 初始化认证密码显示/隐藏功能
    document.getElementById('toggle-auth-password-visibility').addEventListener('click', function() {
        const passwordInput = document.getElementById('auth-password');
        const icon = document.getElementById('auth-password-visibility-icon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });
    
    // 初始化模态框
    const modalElement = document.getElementById('restoreConfigModal');
    if (modalElement) {
        try {
            restoreConfigModal = new bootstrap.Modal(modalElement);
            console.log('恢复配置模态框初始化成功');
        } catch (error) {
            console.error('模态框初始化失败:', error);
        }
    } else {
        console.error('找不到恢复配置模态框元素');
    }
    loadConfig(false); // 初始加载时不显示提示
});

async function loadConfig(showToast = true) {
    try {
        const response = await fetch('/api/config', {
            method: 'GET',
            credentials: 'include',  // 包含Cookie认证信息
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 401) {
            // 认证失败，跳转到登录页面
            window.location.href = '/login';
            return;
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            currentConfig = data.data;
            populateForm(currentConfig);
            if (showToast) {
                showAlert('配置重新加载成功', 'success');
            }
        } else {
            showAlert('加载配置失败: ' + (data.message || '未知错误'), 'danger');
        }
    } catch (error) {
        console.error('加载配置失败:', error);
        showAlert('加载配置失败: ' + error.message, 'danger');
    }
}

function populateForm(config) {
    // 填充基本配置
    document.getElementById('bangumi-username').value = config.bangumi.username || '';
    document.getElementById('bangumi-access-token').value = config.bangumi.access_token || '';
    document.getElementById('bangumi-private').checked = config.bangumi.private || false;
    
    document.getElementById('sync-mode').value = config.sync.mode || 'single';
    document.getElementById('single-username').value = config.sync.single_username || '';
    document.getElementById('blocked-keywords').value = config.sync.blocked_keywords || '';
    
    document.getElementById('script-proxy').value = config.dev.script_proxy || '';
    document.getElementById('ssl-verify').checked = Boolean(config.dev.ssl_verify);
    document.getElementById('debug-mode').checked = Boolean(config.dev.debug);
    
    document.getElementById('bangumi-data-enabled').checked = config.bangumi_data.enabled !== false;
    document.getElementById('bangumi-data-cache').checked = config.bangumi_data.use_cache !== false;
    document.getElementById('cache-ttl').value = config.bangumi_data.cache_ttl_days || 7;
    document.getElementById('data-url').value = config.bangumi_data.data_url || 'https://unpkg.com/bangumi-data@0.3/dist/data.json';
    document.getElementById('local-cache-path').value = config.bangumi_data.local_cache_path || './bangumi_data_cache.json';
    
    // 填充认证配置
    if (config.auth) {
        document.getElementById('auth-enabled').checked = config.auth.enabled !== false;
        document.getElementById('auth-username').value = config.auth.username || 'admin';
        document.getElementById('session-timeout').value = config.auth.session_timeout || 3600;
        document.getElementById('https-only').checked = config.auth.https_only || false;
        document.getElementById('max-login-attempts').value = config.auth.max_login_attempts || 5;
        document.getElementById('lockout-duration').value = config.auth.lockout_duration || 900;
        // 密码字段留空，表示不修改
        document.getElementById('auth-password').value = '';
    }
    
    // 切换同步模式
    toggleSyncMode();
    
    // 填充多用户配置
    if (config.sync.mode === 'multi') {
        populateMultiUserConfig(config.multi_accounts, config.user_mappings);
    }
}

function toggleSyncMode() {
    const mode = document.getElementById('sync-mode').value;
    const singleContainer = document.getElementById('single-username-container');
    const singleBangumiSection = document.getElementById('single-user-bangumi-section');
    const multiSection = document.getElementById('multi-user-section');
    
    if (mode === 'single') {
        // 单用户模式：显示单用户名输入框和Bangumi账号配置，隐藏多用户配置
        singleContainer.style.display = 'block';
        singleBangumiSection.style.display = 'block';
        multiSection.style.display = 'none';
    } else {
        // 多用户模式：隐藏单用户名输入框和Bangumi账号配置，显示多用户配置
        singleContainer.style.display = 'none';
        singleBangumiSection.style.display = 'none';
        multiSection.style.display = 'block';
    }
}

function populateMultiUserConfig(accounts, mappings) {
    const accountsContainer = document.getElementById('bangumi-accounts-container');
    
    accountsContainer.innerHTML = '';
    
    // 重置全局计数器
    bangumiAccountCounter = 0;
    
    // 添加Bangumi账号
    Object.entries(accounts || {}).forEach(([key, account]) => {
        // 使用display_name作为显示名称，如果没有则使用配置段名
        const displayName = account.display_name || key;
        addBangumiAccount(displayName, account);
    });
    
}

function addBangumiAccount(accountName = '', accountConfig = {}) {
    const container = document.getElementById('bangumi-accounts-container');
    const id = bangumiAccountCounter++;
    
    const accountDiv = document.createElement('div');
    accountDiv.className = 'border rounded p-3 mb-3';
    accountDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Bangumi账号 ${id + 1}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBangumiAccount(${id})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">账号备注</label>
                <input type="text" class="form-control bangumi-account-name" value="${accountName}" placeholder="用户昵称或备注">
            </div>
            <div class="col-md-3">
                <label class="form-label">Bangumi用户名</label>
                <input type="text" class="form-control bangumi-account-username" value="${accountConfig.username || ''}" placeholder="Bangumi用户名">
            </div>
            <div class="col-md-3">
                <label class="form-label">媒体服务器用户名</label>
                <input type="text" class="form-control bangumi-account-media-username" value="${accountConfig.media_server_username || ''}" placeholder="Plex/Emby/Jellyfin用户名">
            </div>
            <div class="col-md-3">
                <label class="form-label">访问令牌</label>
                <input type="password" class="form-control bangumi-account-token" value="${accountConfig.access_token || ''}" placeholder="访问令牌">
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input bangumi-account-private" type="checkbox" ${accountConfig.private ? 'checked' : ''}>
                    <label class="form-check-label">观看记录仅自己可见</label>
                </div>
            </div>
        </div>
    `;
    
    accountDiv.id = `bangumi-account-${id}`;
    container.appendChild(accountDiv);
}

function removeBangumiAccount(id) {
    const element = document.getElementById(`bangumi-account-${id}`);
    if (element) {
        element.remove();
    }
}

async function saveConfig() {
    try {
        const configData = {
            bangumi: {
                username: document.getElementById('bangumi-username').value,
                access_token: document.getElementById('bangumi-access-token').value,
                private: document.getElementById('bangumi-private').checked
            },
            sync: {
                mode: document.getElementById('sync-mode').value,
                single_username: document.getElementById('single-username').value,
                blocked_keywords: document.getElementById('blocked-keywords').value
            },
            dev: {
                script_proxy: document.getElementById('script-proxy').value,
                ssl_verify: document.getElementById('ssl-verify').checked,
                debug: document.getElementById('debug-mode').checked
            },
            bangumi_data: {
                enabled: document.getElementById('bangumi-data-enabled').checked,
                use_cache: document.getElementById('bangumi-data-cache').checked,
                cache_ttl_days: parseInt(document.getElementById('cache-ttl').value),
                data_url: document.getElementById('data-url').value,
                local_cache_path: document.getElementById('local-cache-path').value
            },
            auth: {
                enabled: document.getElementById('auth-enabled').checked,
                username: document.getElementById('auth-username').value,
                session_timeout: parseInt(document.getElementById('session-timeout').value) || 3600,
                https_only: document.getElementById('https-only').checked,
                max_login_attempts: parseInt(document.getElementById('max-login-attempts').value) || 5,
                lockout_duration: parseInt(document.getElementById('lockout-duration').value) || 900
            }
        };
        
        // 如果密码字段不为空，则添加到配置中
        const authPassword = document.getElementById('auth-password').value;
        if (authPassword.trim() !== '') {
            configData.auth.password = authPassword;
        }
        
        // 处理多用户配置
        if (configData.sync.mode === 'multi') {
            const multiAccounts = {};
            const userMappings = {};
            
            // 收集Bangumi账号
            document.querySelectorAll('[id^="bangumi-account-"]').forEach((element, index) => {
                const displayName = element.querySelector('.bangumi-account-name').value;
                const username = element.querySelector('.bangumi-account-username').value;
                const mediaUsername = element.querySelector('.bangumi-account-media-username').value;
                const token = element.querySelector('.bangumi-account-token').value;
                const isPrivate = element.querySelector('.bangumi-account-private').checked;
                
                if (username && mediaUsername && token) {
                    // 使用索引生成唯一的键名，实际的配置段名会在后端自动生成
                    const accountKey = displayName || `account_${index + 1}`;
                    multiAccounts[accountKey] = {
                        username: username,
                        access_token: token,
                        media_server_username: mediaUsername,
                        private: isPrivate
                    };
                }
            });
            
            configData.multi_accounts = multiAccounts;
        }
        
        const response = await fetch('/api/config', {
            method: 'POST',
            credentials: 'include',  // 包含Cookie认证信息
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('配置保存成功', 'success');
            
            // 如果修改了密码，提示需要重新登录
            if (authPassword.trim() !== '') {
                setTimeout(() => {
                    if (confirm('您已修改了登录密码，需要重新登录。是否现在跳转到登录页面？')) {
                        // 先登出，然后跳转到登录页面
                        fetch('/api/logout', {
                            method: 'POST',
                            credentials: 'include'
                        }).then(() => {
                            window.location.href = '/login';
                        });
                    }
                }, 1000);
            }
        } else {
            showAlert('配置保存失败: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('保存配置失败:', error);
        showAlert('保存配置失败', 'danger');
    }
}

async function testSync() {
    const btn = document.getElementById('test-sync-btn');
    const progressDiv = document.getElementById('test-sync-progress');
    const statusSpan = document.getElementById('test-sync-status');
    const resultDiv = document.getElementById('test-sync-result');
    const resultAlert = document.getElementById('test-result-alert');
    const resultContent = document.getElementById('test-result-content');
    
    try {
        // 验证表单
        const title = document.getElementById('test-title').value.trim();
        const season = parseInt(document.getElementById('test-season').value);
        const episode = parseInt(document.getElementById('test-episode').value);
        const user = document.getElementById('test-user').value.trim();
        
        if (!title) {
            showAlert('请输入番剧标题', 'warning');
            return;
        }
        if (!user) {
            showAlert('请输入用户名', 'warning');
            return;
        }
        
        // 显示进度
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>测试中...';
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        
        const testData = {
            title: title,
            season: season,
            episode: episode,
            user_name: user
        };
        
        // 更新状态
        statusSpan.textContent = `正在测试同步: ${title} S${season.toString().padStart(2, '0')}E${episode.toString().padStart(2, '0')}`;
        
        const startTime = Date.now();
        
        const response = await fetch('/api/test-sync?async_mode=false', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        const result = await response.json();
        const endTime = Date.now();
        const actualTime = ((endTime - startTime) / 1000).toFixed(2);
        
        // 隐藏进度，显示结果
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        
        if (result.status === 'success') {
            resultAlert.className = 'alert alert-success alert-dismissible fade show';
            resultContent.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="bi bi-check-circle-fill text-success me-3 mt-1"></i>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
                            <h6 class="mb-0 text-success fw-bold">测试同步成功！</h6>
                            <small class="text-muted">
                                <i class="bi bi-stopwatch me-1"></i>${result.elapsed_time || actualTime + '秒'}
                            </small>
                        </div>
                        <div class="mb-3">
                            <span class="text-muted me-2">
                                <i class="bi bi-film me-1"></i>${result.test_info?.title || title}
                            </span>
                            <span class="badge bg-secondary me-2">${result.test_info?.episode || 'S' + season.toString().padStart(2, '0') + 'E' + episode.toString().padStart(2, '0')}</span>
                            ${result.data && (result.data.subject_id || result.data.episode_id) ? `
                                ${result.data.subject_id ? `
                                <a href="https://bgm.tv/subject/${result.data.subject_id}" 
                                   target="_blank" 
                                   class="badge bg-primary text-decoration-none me-1"
                                   title="点击打开Bangumi番剧页面">
                                    <i class="bi bi-collection me-1"></i>ID: ${result.data.subject_id}
                                    <i class="bi bi-box-arrow-up-right ms-1"></i>
                                </a>
                                ` : ''}
                                ${result.data.episode_id ? `
                                <a href="https://bgm.tv/ep/${result.data.episode_id}" 
                                   target="_blank" 
                                   class="badge bg-success text-decoration-none"
                                   title="点击打开Bangumi剧集页面">
                                    <i class="bi bi-play-circle me-1"></i>EP: ${result.data.episode_id}
                                    <i class="bi bi-box-arrow-up-right ms-1"></i>
                                </a>
                                ` : ''}
                            ` : ''}
                        </div>
                        <p class="mb-0 text-muted small">
                            <i class="bi bi-info-circle me-1"></i>${result.message}
                        </p>
                    </div>
                </div>
            `;
            // 已有详细结果展示，不需要额外的Toast提醒
        } else {
            resultAlert.className = 'alert alert-danger alert-dismissible fade show';
            resultContent.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">测试同步失败</h6>
                        <p class="mb-2">${result.message}</p>
                        <div class="row g-2 small text-muted">
                            <div class="col-md-8">
                                <strong>番剧:</strong> ${title} S${season.toString().padStart(2, '0')}E${episode.toString().padStart(2, '0')}
                            </div>
                            <div class="col-md-4">
                                <strong>耗时:</strong> ${result.elapsed_time || actualTime + '秒'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // 已有详细结果展示，不需要额外的Toast提醒
        }
    } catch (error) {
        console.error('测试同步失败:', error);
        
        // 隐藏进度，显示错误
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        resultAlert.className = 'alert alert-danger alert-dismissible fade show';
        resultContent.innerHTML = `
            <div class="d-flex align-items-start">
                <i class="bi bi-x-circle-fill text-danger me-2 mt-1"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-1">网络错误</h6>
                    <p class="mb-0">无法连接到服务器，请检查网络连接或稍后重试。</p>
                    <small class="text-muted">错误详情: ${error.message}</small>
                </div>
            </div>
        `;
        // 已有详细结果展示，不需要额外的Toast提醒
    } finally {
        // 恢复按钮状态
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle me-2"></i>测试同步';
    }
}

// 备份配置
async function backupConfig() {
    try {
        const response = await fetch('/api/config/backup', {
            method: 'POST',
            credentials: 'include',  // 包含Cookie认证信息
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('配置备份成功，已保存到服务器', 'success');
            // 刷新备份文件列表
            await loadBackupFiles();
        } else {
            showAlert('备份配置失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('备份配置失败:', error);
        showAlert('备份配置失败', 'danger');
    }
}

// 显示恢复配置模态框
async function showRestoreModal() {
    console.log('尝试显示恢复配置模态框');
    
    // 确保模态框已初始化
    if (!restoreConfigModal) {
        console.log('模态框未初始化，尝试重新初始化');
        const modalElement = document.getElementById('restoreConfigModal');
        if (modalElement) {
            try {
                restoreConfigModal = new bootstrap.Modal(modalElement);
                console.log('模态框重新初始化成功');
            } catch (error) {
                console.error('模态框初始化失败:', error);
                showAlert('恢复配置功能初始化失败', 'danger');
                return;
            }
        } else {
            console.error('找不到模态框元素');
            showAlert('恢复配置功能暂不可用', 'warning');
            return;
        }
    }
    
    try {
        restoreConfigModal.show();
        console.log('模态框显示成功');
        await loadBackupFiles();
    } catch (error) {
        console.error('显示模态框失败:', error);
        showAlert('无法显示恢复配置对话框', 'danger');
    }
}

// 加载备份文件列表
async function loadBackupFiles() {
    try {
        const response = await fetch('/api/config/backups', {
            credentials: 'include'
        });
        const data = await response.json();
        
        const backupFilesList = document.getElementById('backup-files-list');
        backupFilesList.innerHTML = '';
        
        if (data.status === 'success' && data.data.backups.length > 0) {
            data.data.backups.forEach(backup => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1 me-3" onclick="selectBackupFile('${backup.filename}')" style="cursor: pointer;">
                            <h6 class="mb-1">${backup.filename}</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${backup.created}</small>
                                <small class="text-muted">大小: ${(backup.size / 1024).toFixed(2)} KB</small>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <button class="btn btn-outline-danger btn-sm" 
                                    onclick="deleteBackupFile('${backup.filename}', event)" 
                                    title="删除备份">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                backupFilesList.appendChild(item);
            });
        } else {
            backupFilesList.innerHTML = `
                <div class="text-center p-3">
                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0 text-muted">暂无备份文件</p>
                    <small class="text-muted">点击"备份配置"创建第一个备份</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('加载备份文件失败:', error);
        document.getElementById('backup-files-list').innerHTML = `
            <div class="text-center p-3">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0 text-muted">加载备份文件失败</p>
            </div>
        `;
    }
}

// 选择备份文件
async function selectBackupFile(filename) {
    // 更新选中状态
    document.querySelectorAll('#backup-files-list .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');
    
    // 找到对应的backup对象
    const response = await fetch('/api/config/backups', {
        credentials: 'include'
    });
    const data = await response.json();
    const backup = data.data.backups.find(b => b.filename === filename);
    
    selectedBackupFile = backup;
    document.getElementById('restore-confirm-btn').disabled = false;
    
    // 预览配置内容
    try {
        const response = await fetch(`/api/config/backup/${filename}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            const preview = document.getElementById('config-preview');
            preview.innerHTML = `<pre class="mb-0">${data.data.content}</pre>`;
        } else {
            document.getElementById('config-preview').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    无法预览配置文件: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('预览配置失败:', error);
        document.getElementById('config-preview').innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                预览配置失败
            </div>
        `;
    }
}

// 删除单个备份文件
async function deleteBackupFile(filename, event) {
    event.stopPropagation(); // 阻止事件冒泡
    
    if (!confirm('确定要删除这个备份文件吗？此操作不可逆。')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/config/backup/${filename}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('备份文件删除成功', 'success');
            // 刷新备份文件列表
            await loadBackupFiles();
            
            // 如果删除的是当前选中的文件，清空预览
            if (selectedBackupFile && selectedBackupFile.filename === filename) {
                selectedBackupFile = null;
                document.getElementById('restore-confirm-btn').disabled = true;
                document.getElementById('config-preview').innerHTML = `
                    <p class="text-muted mb-0">选择左侧的备份文件以预览配置内容</p>
                `;
            }
        } else {
            showAlert('删除备份文件失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('删除备份文件失败:', error);
        showAlert('删除备份文件失败', 'danger');
    }
}

// 确认恢复配置
async function confirmRestore() {
    if (!selectedBackupFile) {
        showAlert('请选择要恢复的备份文件', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/config/restore/${selectedBackupFile.filename}`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            if (restoreConfigModal) {
                restoreConfigModal.hide();
            }
            showAlert('配置已恢复，正在重新加载...', 'success');
            
            // 延迟重新加载配置
            setTimeout(() => {
                loadConfig(true);
                // 恢复成功后提醒用户保存配置
                setTimeout(() => {
                    showAlert('配置已恢复成功！请记得点击"保存配置"按钮保存当前设置，避免丢失恢复的配置。', 'warning', 8000);
                }, 1500);
            }, 1000);
        } else {
            showAlert('恢复配置失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('恢复配置失败:', error);
        showAlert('恢复配置失败', 'danger');
    }
}

// 显示清理备份模态框
function showCleanupModal() {
    const cleanupModal = new bootstrap.Modal(document.getElementById('cleanupBackupModal'));
    cleanupModal.show();
}

// 显示代理助手
async function showProxyHelper() {
    const helperDiv = document.getElementById('proxy-helper');
    helperDiv.style.display = 'block';
    
    // 尝试从当前输入框检测端口号
    detectPortFromInput();
    
    // 获取代理建议
    await loadProxySuggestions();
}

// 从输入框检测端口号
function detectPortFromInput(event) {
    // 阻止事件冒泡和默认行为
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const proxyInput = document.getElementById('script-proxy').value.trim();
    const portInput = document.getElementById('proxy-port');
    
    if (!proxyInput) {
        showAlert('代理输入框为空，请先填写代理地址', 'warning', 3000);
        return;
    }
    
    // 尝试从URL中提取端口号，支持多种格式
    const portPatterns = [
        /:(\d+)(?:\/|$)/,           // http://127.0.0.1:7890 或 http://127.0.0.1:7890/
        /:(\d+)(?:\?|#|$)/,         // http://127.0.0.1:7890?param=value
        /127\.0\.0\.1:(\d+)/,       // 127.0.0.1:7890
        /localhost:(\d+)/,          // localhost:7890
        /172\.17\.0\.1:(\d+)/,      // 172.17.0.1:7890
        /host\.docker\.internal:(\d+)/, // host.docker.internal:7890
        /192\.168\.\d+\.\d+:(\d+)/  // 192.168.x.x:7890
    ];
    
    let detectedPort = null;
    
    for (const pattern of portPatterns) {
        const match = proxyInput.match(pattern);
        if (match && match[1]) {
            const port = parseInt(match[1]);
            if (port >= 1 && port <= 65535) {
                detectedPort = port;
                break;
            }
        }
    }
    
    if (detectedPort) {
        portInput.value = detectedPort;
        showAlert(`✅ 已从输入框检测到端口号: ${detectedPort}`, 'success', 3000);
        // 自动更新建议
        updateProxySuggestions();
    } else {
        showAlert('❌ 未能从输入框检测到有效端口号，请检查格式或手动输入', 'warning', 4000);
        // 聚焦到端口输入框
        portInput.focus();
    }
}

        // 更新代理建议
        async function updateProxySuggestions() {
            await loadProxySuggestions();
        }
        
        // 测试主机连通性
        async function testHostConnectivity() {
            const hostInput = document.getElementById('test-host');
            const portInput = document.getElementById('test-port');
            const timeoutInput = document.getElementById('test-timeout');
            const testBtn = document.getElementById('test-host-btn');
            const resultDiv = document.getElementById('host-test-result');
            
            const host = hostInput.value.trim();
            const port = parseInt(portInput.value) || 7890;
            const timeout = parseInt(timeoutInput.value) || 5;
            
            if (!host) {
                showAlert('请输入主机地址', 'warning', 3000);
                hostInput.focus();
                return;
            }
            
            // 显示测试中状态
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>测试中...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        <span>正在测试连接到 ${host}:${port}...</span>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/proxy/test-host', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: host,
                        port: port,
                        timeout: timeout
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayHostTestResult(data.data, host, port);
                } else {
                    showHostTestError('测试失败: ' + data.message);
                }
                
            } catch (error) {
                console.error('主机连通性测试失败:', error);
                showHostTestError('网络错误，无法执行连通性测试');
            } finally {
                // 恢复按钮状态
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i>测试';
            }
        }
        
        // 显示主机测试结果
        function displayHostTestResult(result, host, port) {
            const resultDiv = document.getElementById('host-test-result');
            
            let html = '';
            
            if (result.success) {
                html = `
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle me-2"></i>
                            连接成功！
                        </h6>
                        <p class="mb-2">
                            <strong>目标：</strong>${host}:${port}<br>
                            <strong>响应时间：</strong>${result.response_time}ms
                        </p>
                        <hr>
                        <p class="mb-0 small text-success">
                            <i class="bi bi-info-circle me-1"></i>
                            容器可以访问到宿主机的这个地址和端口，代理配置应该可以正常工作。
                        </p>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="bi bi-x-circle me-2"></i>
                            连接失败
                        </h6>
                        <p class="mb-2">
                            <strong>目标：</strong>${host}:${port}<br>
                            <strong>错误：</strong>${result.error}
                        </p>
                `;
                
                // 添加详细的测试结果
                if (result.details) {
                    html += '<hr><h6 class="small">详细测试结果：</h6>';
                    
                    if (result.details.tcp_test) {
                        const tcpTest = result.details.tcp_test;
                        const tcpIcon = tcpTest.success ? 'check-circle text-success' : 'x-circle text-danger';
                        html += `
                            <p class="small mb-1">
                                <i class="bi bi-${tcpIcon} me-1"></i>
                                <strong>TCP连接：</strong>${tcpTest.success ? '成功' : tcpTest.error}
                            </p>
                        `;
                    }
                    
                    if (result.details.ping_test) {
                        const pingTest = result.details.ping_test;
                        const pingIcon = pingTest.success ? 'check-circle text-success' : 'x-circle text-warning';
                        html += `
                            <p class="small mb-1">
                                <i class="bi bi-${pingIcon} me-1"></i>
                                <strong>Ping测试：</strong>${pingTest.success ? '成功' : pingTest.error}
                            </p>
                        `;
                    }
                }
                
                html += `
                        <hr>
                        <p class="mb-0 small text-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            容器无法访问到宿主机的这个地址和端口，请检查：<br>
                            1. 宿主机IP地址是否正确<br>
                            2. 代理服务是否正在运行<br>
                            3. 防火墙是否允许连接<br>
                            4. 代理是否允许来自Docker网段的连接
                        </p>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        // 显示主机测试错误
        function showHostTestError(message) {
            const resultDiv = document.getElementById('host-test-result');
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6 class="alert-heading">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        测试异常
                    </h6>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }

// 加载代理建议
async function loadProxySuggestions() {
    const portInput = document.getElementById('proxy-port');
    const port = parseInt(portInput.value) || 7890;
    
    try {
        // 获取代理建议
        const response = await fetch(`/api/proxy/suggestions?port=${port}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            displayProxySuggestions(data.data);
        } else {
            showProxyError('获取代理建议失败: ' + data.message);
        }
    } catch (error) {
        console.error('获取代理建议失败:', error);
        showProxyError('网络错误，无法获取代理建议');
    }
}

// 隐藏代理助手
function hideProxyHelper() {
    document.getElementById('proxy-helper').style.display = 'none';
}

// 显示代理建议
function displayProxySuggestions(data) {
    const suggestionsDiv = document.getElementById('proxy-suggestions');
    
    if (!data.suggestions || data.suggestions.length === 0) {
        suggestionsDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                未找到合适的代理配置建议
            </div>
        `;
        return;
    }
    
    const currentPort = document.getElementById('proxy-port').value;
    
    let html = `
        <div class="mb-3">
            <h6 class="text-info">
                <i class="bi bi-info-circle me-2"></i>
                检测到环境: ${data.environment.is_docker ? 'Docker容器' : '本机环境'}
                ${data.environment.is_docker ? `(${data.environment.network_mode}模式)` : '(原生运行)'}
            </h6>
            <p class="small text-muted mb-0">
                ${data.environment.is_docker ? 
                    `已为Docker环境优化代理配置建议，使用端口: ${currentPort}` : 
                    `已为本机环境提供常用代理配置，使用端口: ${currentPort}`}
            </p>
        </div>
        <div class="row g-2">
    `;
    
    data.suggestions.forEach((suggestion, index) => {
        const badgeClass = index === 0 ? 'bg-success' : 'bg-info';
        const recommendText = index === 0 ? '推荐' : '';
        
        html += `
            <div class="col-12">
                <div class="card border-light proxy-suggestion" onclick="selectProxy('${suggestion.address}')" style="cursor: pointer;">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <code class="text-primary">${suggestion.address}</code>
                                <small class="text-muted d-block">${suggestion.description}</small>
                            </div>
                            <div>
                                ${recommendText ? `<span class="badge ${badgeClass}">${recommendText}</span>` : ''}
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="testProxy('${suggestion.address}', event)">
                                    <i class="bi bi-wifi"></i> 测试
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    suggestionsDiv.innerHTML = html;
}

// 显示代理错误
function showProxyError(message) {
    const suggestionsDiv = document.getElementById('proxy-suggestions');
    suggestionsDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// 选择代理
function selectProxy(address) {
    document.getElementById('script-proxy').value = address;
    showAlert('代理地址已填入，记得保存配置', 'success', 3000);
}

// 测试代理连通性
async function testProxy(address, event) {
    event.stopPropagation(); // 阻止冒泡
    
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    // 显示测试状态
    button.disabled = true;
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
    
    try {
        const response = await fetch('/api/proxy/test', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ proxy_url: address })
        });
        
        const data = await response.json();
        
        if (data.status === 'success' && data.data.success) {
            button.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
            showAlert(`代理测试成功 (${data.data.response_time}ms)`, 'success', 3000);
        } else {
            button.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
            showAlert(`代理测试失败: ${data.data.error}`, 'warning', 5000);
        }
    } catch (error) {
        button.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
        showAlert('代理测试失败: 网络错误', 'danger', 5000);
    }
    
    // 3秒后恢复按钮
    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }, 3000);
}

// 确认清理备份
async function confirmCleanup() {
    const strategy = document.querySelector('input[name="cleanupStrategy"]:checked').value;
    let params = { strategy: strategy };
    
    if (strategy === 'recent') {
        params.keep_count = parseInt(document.getElementById('keepCount').value);
    } else if (strategy === 'date') {
        params.keep_days = parseInt(document.getElementById('keepDays').value);
    }
    
    try {
        const response = await fetch('/api/config/backups/cleanup', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            // 关闭模态框
            const cleanupModal = bootstrap.Modal.getInstance(document.getElementById('cleanupBackupModal'));
            cleanupModal.hide();
            // 刷新备份文件列表
            await loadBackupFiles();
        } else {
            showAlert('清理备份失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('清理备份失败:', error);
        showAlert('清理备份失败', 'danger');
    }
}
</script>
{% endblock %} 